<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MED Workout Tracker â€“ Adaptive Priority Training</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .progress-bar { 
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .modal-overlay { 
      backdrop-filter: blur(8px); 
      animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotateZ(0deg); opacity: 1; }
      100% { transform: translateY(1000px) rotateZ(720deg); opacity: 0; }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .card-hover {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }
    .badge-glow {
      box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .scroll-smooth {
      scroll-behavior: smooth;
    }
    .category-expand {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      animation: confetti 3s ease-out forwards;
      pointer-events: none;
      z-index: 9999;
    }
    .toast {
      animation: slideUp 0.3s ease-out;
    }
    .achievement-unlock {
      animation: pulse 0.5s ease-in-out;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f5f7ff',
              100: '#ebf0ff',
              200: '#d6e0ff',
              300: '#b3c7ff',
              400: '#8aa5ff',
              500: '#667eea',
              600: '#5568d3',
              700: '#4552b6',
              800: '#3a4596',
              900: '#2f3777',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen scroll-smooth">
  <div id="app"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // --- Data -----------------------------------------------------------------

    const exerciseLibrary = {
      'Squats': {
        muscles: { quads: 1, glutes: 0.6, core: 0.3 },
        category: 'primary',
        movementCategory: 'squat',
        variants: [
          'Back Squat',
          'Front Squat',
          'Safety Bar Squat',
          'Hack Squat',
          'Pendulum Squat',
          'Goblet Squat',
          'Leg Press',
          'Single-Leg Press',
          'Hack Squat Machine',
          'Belt Squat'
        ]
      },
      'Bench Press': {
        muscles: { chest: 1, triceps: 0.6, shoulders: 0.4 },
        category: 'primary',
        movementCategory: 'press',
        variants: ['Flat Barbell Bench', 'Incline Bench', 'Close Grip Bench', 'Dumbbell Press', 'Machine Press']
      },
      'Overhead Press': {
        muscles: { shoulders: 1, triceps: 0.7, upperBack: 0.3 },
        category: 'primary',
        movementCategory: 'press',
        variants: [
          'Standing Barbell Overhead Press',
          'Seated Dumbbell Shoulder Press',
          'Machine Shoulder Press'
        ]
      },
      'Deadlifts': {
        muscles: { glutes: 1, hamstrings: 1, upperBack: 0.6, core: 0.4 },
        category: 'primary',
        movementCategory: 'posterior',
        variants: ['Conventional Deadlift', 'Sumo Deadlift', 'Trap Bar Deadlift', 'Romanian Deadlift', 'Deficit Deadlift']
      },
      'Rows': {
        muscles: { upperBack: 1, lats: 0.6, biceps: 0.4 },
        category: 'primary',
        movementCategory: 'pull',
        variants: ['Barbell Row', 'Dumbbell Row', 'Chest-Supported Row', 'Cable Row']
      },
      'Pull-ups': {
        muscles: { lats: 1, upperBack: 0.4, biceps: 0.6 },
        category: 'primary',
        movementCategory: 'pull',
        variants: ['Pull-ups', 'Chin-ups', 'Neutral Grip', 'Band-Assisted Pull-ups', 'Lat Pulldown']
      },
      'Lunges': {
        muscles: { quads: 1, glutes: 0.8 },
        category: 'primary',
        movementCategory: 'squat',
        variants: [
          'Walking Lunges',
          'Reverse Lunges',
          'Bulgarian Split Squats',
          'Static Lunges',
          'Step-ups'
        ]
      },
      'Hip Thrusts': {
        muscles: { glutes: 1, hamstrings: 0.5 },
        category: 'primary',
        movementCategory: 'posterior',
        variants: ['Barbell Hip Thrust', 'Dumbbell Hip Thrust', 'Single-Leg Hip Thrust']
      },
      'Leg Curls': {
        muscles: { hamstrings: 1 },
        category: 'accessory',
        movementCategory: 'posterior',
        variants: ['Lying Leg Curl', 'Seated Leg Curl', 'Nordic Curl']
      },
      'Leg Extensions': {
        muscles: { quads: 1 },
        category: 'accessory',
        movementCategory: 'squat',
        variants: ['Leg Extension Machine', 'Single-Leg Extension']
      },
      'Bicep Curls': {
        muscles: { biceps: 1 },
        category: 'accessory',
        movementCategory: 'pull',
        variants: ['Barbell Curl', 'Dumbbell Curl', 'Hammer Curl', 'Cable Curl']
      },
      'Dips': {
        muscles: { chest: 0.8, triceps: 1, shoulders: 0.4 },
        category: 'accessory',
        movementCategory: 'press',
        variants: [
          'Parallel Bar Dips',
          'Assisted Dips',
          'Weighted Dips',
          'Bench Dips'
        ]
      },
      'Tricep Extensions': {
        muscles: { triceps: 1 },
        category: 'accessory',
        movementCategory: 'press',
        variants: ['Rope Pushdown', 'Overhead Extension', 'Skullcrushers', 'Kickbacks']
      },
      'Lateral Raises': {
        muscles: { shoulders: 1 },
        category: 'accessory',
        movementCategory: 'press',
        variants: ['Dumbbell Lateral Raise', 'Cable Lateral Raise', 'Machine Lateral Raise']
      },
      'Face Pulls': {
        muscles: { upperBack: 0.6, shoulders: 0.6 },
        category: 'accessory',
        movementCategory: 'pull',
        variants: ['Rope Face Pulls', 'Cable High Row']
      },
      'Calf Raises': {
        muscles: { calves: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Standing Calf Raises', 'Seated Calf Raises', 'Leg Press Calf Raises']
      },
      'Crunches': {
        muscles: { core: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Floor Crunch', 'Cable Crunch', 'Reverse Crunch']
      },
      'Planks': {
        muscles: { core: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Front Plank', 'Side Plank', 'Weighted Plank']
      },
      'Back Extensions': {
        muscles: { glutes: 0.6, hamstrings: 0.6, core: 0.4 },
        category: 'accessory',
        movementCategory: 'posterior',
        variants: ['Back Extensions', 'Reverse Hyper']
      }
    };

    const movementMuscles = {
      squat: ['quads', 'glutes'],
      posterior: ['hamstrings', 'glutes'],
      pull: ['lats', 'upperBack'],
      press: ['chest', 'shoulders', 'triceps']
    };

    const muscleGroups = {
      primary: ['chest', 'lats', 'upperBack', 'quads', 'glutes', 'hamstrings'],
      accessory: ['shoulders', 'biceps', 'triceps', 'calves', 'core']
    };

    const allMuscles = [...muscleGroups.primary, ...muscleGroups.accessory];
    const MESOCYCLE_WEEKS = 6;

    const majorLifts = {
      'Squats': ['quads', 'glutes'],
      'Bench Press': ['chest', 'triceps'],
      'Deadlifts': ['glutes', 'hamstrings', 'upperBack']
    };

    const movementCategoryMeta = {
      pull: {
        label: 'Pull',
        subtitle: 'Back & Lat Development',
        description: 'Rows, pulldowns, and pull-up variations',
        icon: 'ðŸ’ª',
        gradient: 'from-blue-500 to-cyan-500',
        primaryMuscles: ['lats', 'upperBack'],
        accessoryMuscles: ['biceps']
      },
      squat: {
        label: 'Squat',
        subtitle: 'Knee-Dominant Lower',
        description: 'Squats, lunges, and leg press variations',
        icon: 'ðŸ¦µ',
        gradient: 'from-purple-500 to-pink-500',
        primaryMuscles: ['quads', 'glutes'],
        accessoryMuscles: []
      },
      press: {
        label: 'Press',
        subtitle: 'Chest & Shoulder Pressing',
        description: 'Bench press and overhead pressing movements',
        icon: 'ðŸ’¥',
        gradient: 'from-orange-500 to-red-500',
        primaryMuscles: ['chest'],
        accessoryMuscles: ['shoulders', 'triceps']
      },
      posterior: {
        label: 'Posterior Chain',
        subtitle: 'Hip-Dominant Power',
        description: 'Deadlifts, hip thrusts, and hamstring work',
        icon: 'âš¡',
        gradient: 'from-emerald-500 to-teal-500',
        primaryMuscles: ['glutes', 'hamstrings'],
        accessoryMuscles: []
      }
    };

    const achievementDefinitions = {
      firstWorkout: { 
        icon: 'ðŸŽ¯', 
        label: 'First Steps', 
        description: 'Log your first workout',
        check: (stats) => stats.totalWorkouts >= 1
      },
      week1Complete: { 
        icon: 'âœ…', 
        label: 'Week Warrior', 
        description: 'Complete a full training week',
        check: (stats) => stats.weeksCompleted >= 1
      },
      perfectWeek: { 
        icon: 'â­', 
        label: 'Perfect Week', 
        description: 'Hit all 6 primary muscles in one week',
        check: (stats) => stats.perfectWeeks >= 1
      },
      streak3: { 
        icon: 'ðŸ”¥', 
        label: 'On Fire', 
        description: 'Maintain a 3-week streak',
        check: (stats) => stats.currentStreak >= 3
      },
      streak5: { 
        icon: 'ðŸ”¥ðŸ”¥', 
        label: 'Unstoppable', 
        description: 'Maintain a 5-week streak',
        check: (stats) => stats.currentStreak >= 5
      },
      volume100: { 
        icon: 'ðŸ’¯', 
        label: 'Century Club', 
        description: 'Log 100 total sets',
        check: (stats) => stats.totalSets >= 100
      },
      volume500: { 
        icon: 'ðŸ’ª', 
        label: 'Volume Beast', 
        description: 'Log 500 total sets',
        check: (stats) => stats.totalSets >= 500
      },
      allMusclesHit: { 
        icon: 'ðŸ‘‘', 
        label: 'Completionist', 
        description: 'Hit all 11 muscle groups in one week',
        check: (stats) => stats.allMusclesHitWeeks >= 1
      },
      dedication: {
        icon: 'ðŸ†',
        label: 'Dedication',
        description: 'Log 50 workouts',
        check: (stats) => stats.totalWorkouts >= 50
      }
    };

    // Icons
    const ChevronDown = ({ className = "" }) => (
      <svg className={className} width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="6 9 12 15 18 9" />
      </svg>
    );
    const TrendingUp = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
        <polyline points="17 6 23 6 23 12" />
      </svg>
    );
    const SettingsIcon = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3" />
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83" />
      </svg>
    );
    const CheckCircle = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
        <polyline points="22 4 12 14.01 9 11.01" />
      </svg>
    );
    const Plus = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );
    const Minus = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );
    const Zap = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
      </svg>
    );
    const ArchiveIcon = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="4" rx="2" />
        <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8" />
        <line x1="10" y1="12" x2="14" y2="12" />
      </svg>
    );
    const Activity = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
      </svg>
    );
    const Award = ({ className = "", size = 20 }) => (
      <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="8" r="7" />
        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
      </svg>
    );

    // Helpers
    const getWeekStart = (date = new Date()) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day;
      const weekStart = new Date(d.setDate(diff));
      weekStart.setHours(0, 0, 0, 0);
      return weekStart;
    };

    const daysBetween = (a, b) => {
      const ms = Math.abs(a - b);
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    };

    // Confetti function
    const triggerConfetti = () => {
      const colors = ['#667eea', '#764ba2', '#f59e0b', '#10b981', '#ec4899', '#8b5cf6'];
      const confettiCount = 50;
      
      for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti-piece';
          confetti.style.left = Math.random() * window.innerWidth + 'px';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.3 + 's';
          document.body.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
      }
    };

    const App = () => {
      const [currentView, setCurrentView] = useState('workout');
      const [workoutHistory, setWorkoutHistory] = useState(() => {
        const saved = localStorage.getItem('medApp_workoutHistory');
        return saved ? JSON.parse(saved) : [];
      });
      const [lastStrengthWorkout, setLastStrengthWorkout] = useState(() => {
        const saved = localStorage.getItem('medApp_lastStrengthWorkout');
        return saved ? JSON.parse(saved) : {};
      });
      const [medTarget, setMedTarget] = useState(() => {
        const saved = localStorage.getItem('medApp_medTarget');
        return saved ? parseInt(saved) : 10;
      });
      const [strengthCycleDays, setStrengthCycleDays] = useState(() => {
        const saved = localStorage.getItem('medApp_strengthCycleDays');
        return saved ? parseInt(saved) : 14;
      });
      const [lastUsedVariants, setLastUsedVariants] = useState(() => {
        const saved = localStorage.getItem('medApp_lastUsedVariants');
        return saved ? JSON.parse(saved) : {};
      });
      const [achievements, setAchievements] = useState(() => {
        const saved = localStorage.getItem('medApp_achievements');
        return saved ? JSON.parse(saved) : {};
      });
      const [personalBests, setPersonalBests] = useState(() => {
        const saved = localStorage.getItem('medApp_personalBests');
        return saved ? JSON.parse(saved) : {};
      });
      const [expandedExercises, setExpandedExercises] = useState({});
      const [expandedCategories, setExpandedCategories] = useState({});
      const [selectedVariants, setSelectedVariants] = useState({});
      const [setSets, setSetSets] = useState({});
      const [structuredSession, setStructuredSession] = useState(null);
      const [toasts, setToasts] = useState([]);
      const [showAlmostDone, setShowAlmostDone] = useState(false);
      const [almostDoneSuggestions, setAlmostDoneSuggestions] = useState([]);
      
      const [showQuickAdd, setShowQuickAdd] = useState(false);
      const [quickAddExercise, setQuickAddExercise] = useState('');
      const [quickAddVariant, setQuickAddVariant] = useState('');
      const [quickAddSets, setQuickAddSets] = useState(3);
      
      const [currentWeekStart] = useState(() => getWeekStart());
      const [mesocycleStart] = useState(() => {
        const saved = localStorage.getItem('medApp_mesocycleStart');
        return saved ? new Date(saved) : getWeekStart();
      });

      // Persist
      useEffect(() => {
        localStorage.setItem('medApp_workoutHistory', JSON.stringify(workoutHistory));
      }, [workoutHistory]);
      useEffect(() => {
        localStorage.setItem('medApp_lastStrengthWorkout', JSON.stringify(lastStrengthWorkout));
      }, [lastStrengthWorkout]);
      useEffect(() => {
        localStorage.setItem('medApp_medTarget', medTarget.toString());
      }, [medTarget]);
      useEffect(() => {
        localStorage.setItem('medApp_strengthCycleDays', strengthCycleDays.toString());
      }, [strengthCycleDays]);
      useEffect(() => {
        localStorage.setItem('medApp_lastUsedVariants', JSON.stringify(lastUsedVariants));
      }, [lastUsedVariants]);
      useEffect(() => {
        localStorage.setItem('medApp_achievements', JSON.stringify(achievements));
      }, [achievements]);
      useEffect(() => {
        localStorage.setItem('medApp_personalBests', JSON.stringify(personalBests));
      }, [personalBests]);

      // Init sets
      useEffect(() => {
        const initial = {};
        Object.keys(exerciseLibrary).forEach(name => {
          initial[name] = 3;
        });
        setSetSets(initial);
      }, []);

      // Toast system
      const showToast = useCallback((message, type = 'success', icon = 'âœ“') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type, icon }]);
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, 3000);
      }, []);

      // Calculate weekly volumes
      const processWeeklyVolumes = useCallback(() => {
        const weekMap = new Map();
        
        workoutHistory.forEach(workout => {
          const workoutDate = new Date(workout.date);
          const weekStart = getWeekStart(workoutDate);
          const weekKey = weekStart.toISOString();
          
          if (!weekMap.has(weekKey)) {
            weekMap.set(weekKey, {
              weekStart: weekKey,
              volumes: {},
              workouts: []
            });
            allMuscles.forEach(m => weekMap.get(weekKey).volumes[m] = 0);
          }
          
          const weekData = weekMap.get(weekKey);
          weekData.workouts.push(workout);
          
          const exercise = exerciseLibrary[workout.exercise];
          if (exercise) {
            Object.entries(exercise.muscles).forEach(([muscle, multiplier]) => {
              if (allMuscles.includes(muscle)) {
                weekData.volumes[muscle] += workout.sets * multiplier;
              }
            });
          }
        });
        
        // Calculate grades
        weekMap.forEach((data, key) => {
          const musclesHit = muscleGroups.primary.filter(m => 
            data.volumes[m] >= medTarget
          ).length;
          
          if (musclesHit === 6) {
            data.grade = { grade: 'S', color: 'from-purple-500 to-pink-500', label: 'Perfect!' };
          } else if (musclesHit >= 5) {
            data.grade = { grade: 'A', color: 'from-blue-500 to-cyan-500', label: 'Excellent' };
          } else if (musclesHit >= 4) {
            data.grade = { grade: 'B', color: 'from-green-500 to-emerald-500', label: 'Great' };
          } else if (musclesHit >= 3) {
            data.grade = { grade: 'C', color: 'from-yellow-500 to-orange-500', label: 'Good' };
          } else {
            data.grade = { grade: 'D', color: 'from-red-500 to-pink-500', label: 'Keep Going' };
          }
        });
        
        const volumes = Array.from(weekMap.values())
          .sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart))
          .slice(0, MESOCYCLE_WEEKS);
        
        return volumes;
      }, [workoutHistory, medTarget]);

      const weeklyVolumes = React.useMemo(() => processWeeklyVolumes(), [processWeeklyVolumes]);

      const getMesocycleAverage = useCallback(() => {
        if (weeklyVolumes.length === 0) {
          const empty = {};
          allMuscles.forEach(muscle => empty[muscle] = 0);
          return empty;
        }

        const totals = {};
        allMuscles.forEach(muscle => totals[muscle] = 0);

        weeklyVolumes.forEach(week => {
          allMuscles.forEach(muscle => {
            totals[muscle] += week.volumes[muscle] || 0;
          });
        });

        const averages = {};
        allMuscles.forEach(muscle => {
          averages[muscle] = totals[muscle] / weeklyVolumes.length;
        });

        return averages;
      }, [weeklyVolumes]);

      // Volumes / priorities
      const getCurrentWeekWorkouts = useCallback(() => {
        const end = new Date(currentWeekStart);
        end.setDate(end.getDate() + 7);
        return workoutHistory.filter(w => {
          const d = new Date(w.date);
          return d >= currentWeekStart && d < end;
        });
      }, [workoutHistory, currentWeekStart]);

      const calculateCurrentWeekVolume = useCallback(() => {
        const volume = {};
        allMuscles.forEach(m => (volume[m] = 0));
        getCurrentWeekWorkouts().forEach(w => {
          const ex = exerciseLibrary[w.exercise];
          if (!ex) return;
          Object.entries(ex.muscles).forEach(([muscle, mult]) => {
            if (!allMuscles.includes(muscle)) return;
            volume[muscle] += w.sets * mult;
          });
        });
        return volume;
      }, [getCurrentWeekWorkouts]);

      const getMuscleGroupPriorities = useCallback(() => {
        const current = calculateCurrentWeekVolume();
        const mesocycleAvg = getMesocycleAverage();
        
        return allMuscles
          .map(muscle => {
            const currentVol = current[muscle] || 0;
            const remaining = Math.max(0, medTarget - currentVol);
            const percentage = medTarget > 0 ? (currentVol / medTarget) * 100 : 0;
            const isPrimary = muscleGroups.primary.includes(muscle);
            const mesocycleAvg_ = mesocycleAvg[muscle] || 0;
            const chronicDeficit = isPrimary && mesocycleAvg_ < (medTarget * 0.8);
            const priority = remaining * (isPrimary ? 2 : 1) + (chronicDeficit ? 5 : 0);
            
            return {
              muscle,
              current: currentVol,
              remaining,
              percentage,
              isPrimary,
              mesocycleAvg: mesocycleAvg_,
              chronicDeficit,
              priority
            };
          })
          .sort((a, b) => b.priority - a.priority);
      }, [calculateCurrentWeekVolume, getMesocycleAverage, medTarget]);

      const getSmartRecommendations = useCallback(() => {
        const priorities = getMuscleGroupPriorities();
        const currentWeekVolume = calculateCurrentWeekVolume();

        const topNeeds = priorities
          .filter(p => p.isPrimary && p.remaining > 0)
          .slice(0, 6);

        const recs = [];

        Object.entries(exerciseLibrary).forEach(([exercise, data]) => {
          if (data.category === 'accessory') return;

          let score = 0;
          const targets = [];

          topNeeds.forEach(need => {
            const muscleScore = data.muscles[need.muscle] || 0;
            if (muscleScore > 0) {
              const alreadyHit = (currentWeekVolume[need.muscle] || 0) > 0;
              const zeroBoost = alreadyHit ? 1.0 : 1.5;
              const chronicBoost = need.chronicDeficit ? 1.5 : 1.0;
              const weight = need.remaining * 3 * zeroBoost * chronicBoost;
              score += muscleScore * weight;
              targets.push(need.muscle);
            }
          });

          if (score > 0) {
            const primaryMuscle =
              Object.entries(data.muscles).find(([_, s]) => s === 1)?.[0] ||
              targets[0] ||
              'mixed';

            recs.push({
              exercise,
              score: score.toFixed(1),
              targets: targets.length ? targets : [primaryMuscle],
              primaryMuscle,
              category: data.category,
              variants: data.variants,
              movementCategory: data.movementCategory || 'press'
            });
          }
        });

        // Ensure Big 3 are present
        Object.keys(majorLifts).forEach(lift => {
          const exists = recs.some(r => r.exercise === lift);
          if (!exists && exerciseLibrary[lift]) {
            const data = exerciseLibrary[lift];
            const primaryMuscle =
              Object.entries(data.muscles).find(([_, s]) => s === 1)?.[0] ||
              'mixed';
            const targets = Object.keys(data.muscles).filter(m =>
              muscleGroups.primary.includes(m)
            );
            recs.push({
              exercise: lift,
              score: '0.1',
              targets: targets.length ? targets : [primaryMuscle],
              primaryMuscle,
              category: data.category,
              variants: data.variants,
              movementCategory: data.movementCategory || 'press'
            });
          }
        });

        return recs.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
      }, [getMuscleGroupPriorities, calculateCurrentWeekVolume]);

      // Calculate stats for achievements
      const calculateStats = useCallback(() => {
        const totalWorkouts = workoutHistory.length;
        const totalSets = workoutHistory.reduce((sum, w) => sum + w.sets, 0);
        
        // Calculate streaks
        let currentStreak = 0;
        let bestStreak = 0;
        let tempStreak = 0;
        
        const sortedWeeks = [...weeklyVolumes].sort((a, b) => 
          new Date(a.weekStart) - new Date(b.weekStart)
        );
        
        sortedWeeks.forEach((week, index) => {
          const musclesHit = muscleGroups.primary.filter(m => 
            week.volumes[m] >= medTarget
          ).length;
          
          if (musclesHit >= 4) { // At least 4 muscles hit = streak continues
            tempStreak++;
            bestStreak = Math.max(bestStreak, tempStreak);
            
            // Check if this is current week
            if (week.weekStart === currentWeekStart.toISOString()) {
              currentStreak = tempStreak;
            }
          } else {
            tempStreak = 0;
          }
        });
        
        const perfectWeeks = weeklyVolumes.filter(week => {
          const musclesHit = muscleGroups.primary.filter(m => 
            week.volumes[m] >= medTarget
          ).length;
          return musclesHit === 6;
        }).length;
        
        const allMusclesHitWeeks = weeklyVolumes.filter(week => {
          return allMuscles.every(m => week.volumes[m] >= medTarget);
        }).length;
        
        const weeksCompleted = weeklyVolumes.filter(week => {
          const musclesHit = muscleGroups.primary.filter(m => 
            week.volumes[m] >= medTarget
          ).length;
          return musclesHit >= 4;
        }).length;
        
        return {
          totalWorkouts,
          totalSets,
          currentStreak,
          bestStreak,
          perfectWeeks,
          allMusclesHitWeeks,
          weeksCompleted
        };
      }, [workoutHistory, weeklyVolumes, medTarget, currentWeekStart]);

      // Check and unlock achievements
      useEffect(() => {
        const stats = calculateStats();
        let newlyUnlocked = [];
        
        Object.entries(achievementDefinitions).forEach(([key, def]) => {
          if (!achievements[key] && def.check(stats)) {
            newlyUnlocked.push(key);
            setAchievements(prev => ({ ...prev, [key]: true }));
          }
        });
        
        if (newlyUnlocked.length > 0) {
          newlyUnlocked.forEach(key => {
            const def = achievementDefinitions[key];
            showToast(`Achievement Unlocked: ${def.label}!`, 'achievement', def.icon);
          });
        }
      }, [workoutHistory, achievements, calculateStats, showToast]);

      // Update personal bests
      const updatePersonalBests = useCallback((currentWeekVolume) => {
        let updated = false;
        const newBests = { ...personalBests };
        
        allMuscles.forEach(muscle => {
          const current = currentWeekVolume[muscle] || 0;
          const best = personalBests[muscle] || 0;
          
          if (current > best) {
            newBests[muscle] = current;
            updated = true;
          }
        });
        
        if (updated) {
          setPersonalBests(newBests);
        }
      }, [personalBests]);

      // Get exercises done this week to avoid repetition
      const getExercisesDoneThisWeek = useCallback(() => {
        const thisWeekWorkouts = getCurrentWeekWorkouts();
        return new Set(thisWeekWorkouts.map(w => w.exercise));
      }, [getCurrentWeekWorkouts]);

      const buildPrioritySessionFromTopRecs = useCallback(() => {
        if (!smartRecs || smartRecs.length === 0) return;

        const exercisesDoneThisWeek = getExercisesDoneThisWeek();
        
        // Prefer exercises NOT done this week
        const notDoneThisWeek = smartRecs.filter(rec => !exercisesDoneThisWeek.has(rec.exercise));
        const topPool = (notDoneThisWeek.length >= 6 ? notDoneThisWeek : smartRecs).slice(0, 10);
        const shuffled = [...topPool].sort(() => Math.random() - 0.5);

        const chosen = [];
        const usedCategories = new Set();

        // First pass: one from each movement category
        shuffled.forEach(rec => {
          if (chosen.length >= 3) return;
          const cat = rec.movementCategory || 'press';
          if (!usedCategories.has(cat)) {
            chosen.push(rec);
            usedCategories.add(cat);
          }
        });

        // Second pass: fill remaining slots
        if (chosen.length < 3) {
          shuffled.forEach(rec => {
            if (chosen.length >= 3) return;
            if (!chosen.some(c => c.exercise === rec.exercise)) {
              chosen.push(rec);
            }
          });
        }

        if (chosen.length === 0) return;

        // RANDOMIZE THE ORDER - don't always put highest priority first
        const randomizedOrder = [...chosen].sort(() => Math.random() - 0.5);

        // 35% chance to add an accessory finisher
        let finisher = null;
        const shouldAddFinisher =
          accessoryNeeds &&
          accessoryNeeds.length > 0 &&
          Math.random() < 0.35;

        if (shouldAddFinisher) {
          const topAccessoryNeed = accessoryNeeds[0];
          const accessoryCandidates = Object.entries(exerciseLibrary)
            .filter(([name, data]) => data.category === 'accessory')
            .filter(([_, data]) => !!data.muscles[topAccessoryNeed.muscle]);

          if (accessoryCandidates.length > 0) {
            const [name, data] =
              accessoryCandidates[
                Math.floor(Math.random() * accessoryCandidates.length)
              ];

            const primaryMuscle =
              Object.entries(data.muscles).find(([_, s]) => s === 1)?.[0] ||
              topAccessoryNeed.muscle;

            finisher = {
              exercise: name,
              score: null,
              targets: [topAccessoryNeed.muscle],
              primaryMuscle,
              category: data.category,
              variants: data.variants,
              movementCategory: data.movementCategory || 'accessory'
            };
          }
        }

        const [tier1, tier2, tier3] = randomizedOrder;

        setStructuredSession({
          lift: 'Priority-based',
          tier1,
          tier2: tier2 || null,
          tier3: tier3 || null,
          tier4: finisher || null
        });
        
        showToast('Session built from your top priorities!', 'success', 'ðŸ’ª');
      }, [smartRecs, accessoryNeeds, showToast, getExercisesDoneThisWeek]);

      // Logging
      const logWorkout = useCallback((exercise, variant, sets) => {
        const newEntry = {
          exercise,
          variant,
          sets,
          date: new Date().toISOString(),
          id: Date.now()
        };
        
        // Check if this completes a muscle group
        const currentVolume = calculateCurrentWeekVolume();
        const ex = exerciseLibrary[exercise];
        if (ex) {
          Object.entries(ex.muscles).forEach(([muscle, multiplier]) => {
            if (allMuscles.includes(muscle)) {
              const newVolume = (currentVolume[muscle] || 0) + (sets * multiplier);
              const wasIncomplete = currentVolume[muscle] < medTarget;
              const nowComplete = newVolume >= medTarget;
              
              if (wasIncomplete && nowComplete) {
                triggerConfetti();
                showToast(`${muscle.charAt(0).toUpperCase() + muscle.slice(1)} target hit! ðŸŽ‰`, 'celebration', 'ðŸŽ¯');
              }
            }
          });
        }
        
        setWorkoutHistory(prev => [...prev, newEntry]);

        if (majorLifts[exercise]) {
          setLastStrengthWorkout(prev => ({
            ...prev,
            [exercise]: new Date().toISOString()
          }));
        }

        setLastUsedVariants(prev => ({
          ...prev,
          [exercise]: variant
        }));
        
        showToast(`Logged ${sets} sets of ${variant}`, 'success', 'âœ“');
        
        // Update personal bests
        const updatedVolume = { ...currentVolume };
        if (ex) {
          Object.entries(ex.muscles).forEach(([muscle, multiplier]) => {
            if (allMuscles.includes(muscle)) {
              updatedVolume[muscle] = (updatedVolume[muscle] || 0) + (sets * multiplier);
            }
          });
        }
        updatePersonalBests(updatedVolume);
        
        // Check for "almost done" muscles (1-2 sets away from MED target)
        setTimeout(() => {
          const almostDone = [];
          allMuscles.forEach(muscle => {
            const current = updatedVolume[muscle] || 0;
            const remaining = medTarget - current;
            
            if (remaining > 0 && remaining <= 2) {
              // Find quick exercises that could complete this muscle
              const quickExercises = Object.entries(exerciseLibrary)
                .filter(([name, data]) => {
                  const muscleContribution = data.muscles[muscle] || 0;
                  return muscleContribution >= 0.8; // High contribution to this muscle
                })
                .map(([name, data]) => ({
                  exercise: name,
                  remaining: remaining,
                  muscle: muscle,
                  category: data.category,
                  variants: data.variants
                }));
              
              if (quickExercises.length > 0) {
                almostDone.push({
                  muscle,
                  remaining: remaining.toFixed(1),
                  exercises: quickExercises.slice(0, 3) // Top 3 suggestions
                });
              }
            }
          });
          
          if (almostDone.length > 0) {
            setAlmostDoneSuggestions(almostDone);
            setShowAlmostDone(true);
          }
        }, 1000); // Small delay so confetti/toasts appear first
      }, [calculateCurrentWeekVolume, medTarget, showToast, updatePersonalBests]);

      // Derived
      const priorities = getMuscleGroupPriorities();
      const smartRecs = React.useMemo(() => getSmartRecommendations(), [getSmartRecommendations]);
      const currentWeekVolume = calculateCurrentWeekVolume();
      const stats = calculateStats();

      // Map muscle -> percentage for quick lookup
      const muscleProgress = {};
      priorities.forEach(p => {
        muscleProgress[p.muscle] = p.percentage;
      });

      const weekNumber =
        Math.floor(
          (new Date() - currentWeekStart) / (1000 * 60 * 60 * 24 * 7)
        ) + 1;

      const accessoryNeeds = priorities
        .filter(p => !p.isPrimary && p.remaining > 0)
        .sort((a, b) => b.remaining - a.remaining)
        .slice(0, 3);

      // Group by movement category
      const movementKeys = ['pull', 'squat', 'press', 'posterior'];
      const categoryBuckets = {};
      movementKeys.forEach(k => (categoryBuckets[k] = { exercises: [], score: 0 }));

      smartRecs.forEach(rec => {
        const cat = rec.movementCategory;
        if (!movementKeys.includes(cat)) return;
        categoryBuckets[cat].exercises.push(rec);
        categoryBuckets[cat].score += parseFloat(rec.score || 0);
      });

      const sortedCategories = Object.entries(categoryBuckets)
        .filter(([, bucket]) => bucket.exercises.length > 0)
        .sort((a, b) => b[1].score - a[1].score);

      // Current week grade
      const currentWeekGrade = React.useMemo(() => {
        const musclesHit = muscleGroups.primary.filter(m => 
          currentWeekVolume[m] >= medTarget
        ).length;
        
        if (musclesHit === 6) return { grade: 'S', color: 'from-purple-500 to-pink-500', label: 'Perfect!' };
        if (musclesHit >= 5) return { grade: 'A', color: 'from-blue-500 to-cyan-500', label: 'Excellent' };
        if (musclesHit >= 4) return { grade: 'B', color: 'from-green-500 to-emerald-500', label: 'Great' };
        if (musclesHit >= 3) return { grade: 'C', color: 'from-yellow-500 to-orange-500', label: 'Good' };
        return { grade: 'D', color: 'from-red-500 to-pink-500', label: 'Keep Going' };
      }, [currentWeekVolume, medTarget]);

      // Components
      const ProgressRing = ({ percentage, size = 60, strokeWidth = 6, muscle }) => {
        const radius = (size - strokeWidth) / 2;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;
        
        let colorClass = 'text-red-500';
        if (percentage >= 100) colorClass = 'text-emerald-500';
        else if (percentage >= 75) colorClass = 'text-lime-500';
        else if (percentage >= 50) colorClass = 'text-amber-500';
        
        return (
          <div className="relative inline-flex items-center justify-center">
            <svg width={size} height={size} className="transform -rotate-90">
              <circle
                cx={size / 2}
                cy={size / 2}
                r={radius}
                fill="none"
                stroke="currentColor"
                strokeWidth={strokeWidth}
                className="text-slate-200"
              />
              <circle
                cx={size / 2}
                cy={size / 2}
                r={radius}
                fill="none"
                stroke="currentColor"
                strokeWidth={strokeWidth}
                strokeDasharray={circumference}
                strokeDashoffset={offset}
                strokeLinecap="round"
                className={`${colorClass} transition-all duration-500`}
              />
            </svg>
            <div className="absolute inset-0 flex flex-col items-center justify-center">
              <span className="text-[8px] font-bold text-slate-900 capitalize leading-tight text-center">
                {muscle.substring(0, 4)}
              </span>
              <span className={`text-[9px] font-bold ${colorClass}`}>
                {Math.round(percentage)}%
              </span>
            </div>
          </div>
        );
      };

      const ExerciseCard = ({ rec }) => {
        const isExpanded = !!expandedExercises[rec.exercise];

        // 60% chance to use last-used variant, 40% chance to randomize for variety
        const defaultVariant = React.useMemo(() => {
          const useLastUsed = Math.random() < 0.6;
          
          if (useLastUsed && lastUsedVariants[rec.exercise] && rec.variants?.includes(lastUsedVariants[rec.exercise])) {
            return lastUsedVariants[rec.exercise];
          }
          
          // Otherwise pick a random variant
          const variants = rec.variants || [rec.exercise];
          return variants[Math.floor(Math.random() * variants.length)];
        }, [rec.exercise, rec.variants]);

        const selectedVariant = selectedVariants[rec.exercise] || defaultVariant;
        const sets = setSets[rec.exercise] || 3;

        const handleToggle = () => {
          if (!expandedExercises[rec.exercise] && !selectedVariants[rec.exercise]) {
            setSelectedVariants(prev => ({
              ...prev,
              [rec.exercise]: defaultVariant
            }));
          }

          setExpandedExercises(prev => {
            const isCurrentlyOpen = !!prev[rec.exercise];
            if (isCurrentlyOpen) {
              return {};
            }
            return { [rec.exercise]: true };
          });
        };

        const handleLog = () => {
          logWorkout(rec.exercise, selectedVariant, sets);
          setExpandedExercises({});
        };

        const hasScore = rec.score !== null && rec.score !== undefined;

        return (
          <div className={`card-hover rounded-xl overflow-hidden bg-white border transition-all duration-200 ${
            isExpanded 
              ? 'border-primary-400 shadow-lg ring-2 ring-primary-100' 
              : 'border-slate-200 shadow-sm'
          }`}>
            <button
              type="button"
              onClick={handleToggle}
              className={`w-full text-left px-4 py-3.5 flex flex-col gap-2 transition-colors ${
                isExpanded ? 'bg-gradient-to-r from-primary-50 to-indigo-50' : 'bg-white hover:bg-slate-50'
              }`}
            >
              <div className="flex justify-between items-start gap-3">
                <div className="flex-1 min-w-0">
                  <div className="text-base font-bold text-slate-900 mb-1.5 tracking-tight">
                    {rec.exercise}
                  </div>
                  
                  <div className="flex flex-wrap items-center gap-1.5">
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold ${
                      rec.category === 'primary'
                        ? 'bg-gradient-to-r from-primary-500 to-indigo-500 text-white'
                        : 'bg-slate-100 text-slate-700'
                    }`}>
                      {rec.category === 'primary' ? 'Compound' : 'Accessory'}
                    </span>
                  </div>

                  <div className="text-xs text-slate-500 mt-1.5 flex items-center gap-1.5">
                    <span className="font-medium text-slate-700 capitalize">{rec.primaryMuscle}</span>
                    <span>â€¢</span>
                    <span>Targets: {rec.targets?.join(', ') || rec.primaryMuscle}</span>
                  </div>
                </div>

                <div className="flex flex-col items-end gap-1.5">
                  {hasScore && (
                    <span className="inline-flex items-center px-2.5 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-primary-500 to-indigo-500 text-white badge-glow">
                      {rec.score}
                    </span>
                  )}
                  <div className={`inline-flex items-center justify-center w-7 h-7 rounded-full border-2 transition-all duration-200 ${
                    isExpanded 
                      ? 'border-primary-400 bg-primary-50 text-primary-600 rotate-180' 
                      : 'border-slate-200 bg-white text-slate-400'
                  }`}>
                    <ChevronDown className="w-4 h-4" />
                  </div>
                </div>
              </div>
            </button>

            {isExpanded && (
              <div className="px-4 py-4 border-t-2 border-primary-100 bg-gradient-to-b from-slate-50 to-white space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block mb-2 text-sm font-semibold text-slate-700">
                      Variation
                    </label>
                    <select
                      value={selectedVariant}
                      onChange={e =>
                        setSelectedVariants(prev => ({
                          ...prev,
                          [rec.exercise]: e.target.value
                        }))
                      }
                      className="w-full border-2 border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-white transition-all"
                    >
                      {rec.variants?.map(v => (
                        <option key={v} value={v}>
                          {v}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block mb-2 text-sm font-semibold text-slate-700">
                      Sets
                    </label>
                    <div className="flex items-center gap-3">
                      <button
                        type="button"
                        onClick={() =>
                          setSetSets(prev => ({
                            ...prev,
                            [rec.exercise]: Math.max(1, sets - 1)
                          }))
                        }
                        className="p-2.5 border-2 border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-95"
                      >
                        <Minus className="text-slate-600" size={18} />
                      </button>
                      <span className="text-2xl font-bold min-w-[3rem] text-center text-slate-900">
                        {sets}
                      </span>
                      <button
                        type="button"
                        onClick={() =>
                          setSetSets(prev => ({
                            ...prev,
                            [rec.exercise]: Math.min(10, sets + 1)
                          }))
                        }
                        className="p-2.5 border-2 border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-95"
                      >
                        <Plus className="text-slate-600" size={18} />
                      </button>
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  onClick={handleLog}
                  className="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-bold hover:from-emerald-600 hover:to-teal-600 shadow-md hover:shadow-lg transition-all active:scale-98"
                >
                  <CheckCircle size={20} />
                  <span>Log {sets} sets of {selectedVariant}</span>
                </button>
              </div>
            )}
          </div>
        );
      };

      const CategoryCard = ({ catKey, bucket }) => {
        const meta = movementCategoryMeta[catKey];
        if (!meta) return null;

        const isExpanded = expandedCategories[catKey];
        const score = bucket.score.toFixed(1);
        const exercises = bucket.exercises.slice(0, 4);

        const relevantMuscles = [...meta.primaryMuscles, ...meta.accessoryMuscles];
        const muscleProgress = priorities.filter(p => relevantMuscles.includes(p.muscle));

        const minPct = muscleProgress.length
          ? Math.min(...muscleProgress.map(p => p.percentage))
          : 0;

        let borderColor = 'border-rose-400';
        if (minPct >= 100) {
          borderColor = 'border-emerald-500';
        } else if (minPct >= 75) {
          borderColor = 'border-lime-400';
        } else if (minPct >= 50) {
          borderColor = 'border-amber-400';
        }

        return (
          <div className={`card-hover rounded-xl overflow-hidden bg-white border ${borderColor} shadow-md`}>
            <button
              type="button"
              onClick={() =>
                setExpandedCategories(prev => ({ ...prev, [catKey]: !prev[catKey] }))
              }
              className={`w-full px-4 py-4 bg-gradient-to-r ${meta.gradient} text-white transition-all`}
            >
              <div className="flex items-start justify-between gap-3">
                <div className="flex-1 text-left">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-2xl">{meta.icon}</span>
                    <h3 className="text-base font-bold">{meta.label}</h3>
                  </div>
                  <p className="text-xs text-white/90 mb-1">{meta.subtitle}</p>
                  <p className="text-xs text-white/75">{meta.description}</p>
                  <p className="text-[10px] text-white/80 mt-1">
                    Weekly progress: {Math.round(minPct)}%
                  </p>
                </div>
                <div className="flex flex-col items-end gap-1.5">
                  <span className="inline-flex items-center px-3 py-1.5 text-sm font-bold rounded-full bg-white/20 backdrop-blur-sm border border-white/30 text-white">
                    {score}
                  </span>
                  <div
                    className={`inline-flex items-center justify-center w-7 h-7 rounded-full bg-white/10 border border-white/20 transition-all duration-200 ${
                      isExpanded ? 'rotate-180' : ''
                    }`}
                  >
                    <ChevronDown className="w-4 h-4" />
                  </div>
                </div>
              </div>
            </button>

            {isExpanded && (
              <div className="category-expand">
                <div className="px-4 py-3 bg-slate-50 border-b border-slate-200">
                  <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">
                    This Week&apos;s Progress
                  </h4>
                  <div className="space-y-2.5">
                    {muscleProgress.map(p => (
                      <div key={p.muscle} className="space-y-1.5">
                        <div className="flex justify-between items-center text-xs">
                          <span className="capitalize font-semibold text-slate-900">
                            {p.muscle} {!p.isPrimary && '(accessory)'}
                          </span>
                          <span
                            className={`font-bold ${
                              p.current >= medTarget ? 'text-emerald-600' : 'text-slate-600'
                            }`}
                          >
                            {p.current.toFixed(1)}/{medTarget}
                          </span>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                          <div
                            className={`progress-bar h-2 rounded-full ${
                              p.isPrimary
                                ? p.percentage >= 100
                                  ? 'bg-gradient-to-r from-emerald-500 to-teal-500'
                                  : p.percentage >= 60
                                  ? 'bg-gradient-to-r from-yellow-400 to-orange-400'
                                  : 'bg-gradient-to-r from-red-400 to-pink-400'
                                : 'bg-gradient-to-r from-blue-400 to-cyan-400'
                            }`}
                            style={{ width: `${Math.min(p.percentage, 100)}%` }}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="p-3 bg-white space-y-2.5">
                  <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500 px-1">
                    Recommended Exercises
                  </h4>
                  {exercises.map(rec => (
                    <ExerciseCard key={rec.exercise} rec={rec} />
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      const WorkoutView = () => (
        <div className="space-y-5">
          {/* Hero Header */}
          <div className="relative overflow-hidden rounded-2xl shadow-xl">
            <div className="absolute inset-0 bg-gradient-to-br from-primary-600 via-indigo-600 to-purple-600"></div>
            <div className="absolute inset-0 bg-black/10"></div>
            <div className="relative px-6 py-8">
              <div className="flex justify-between items-start mb-4">
                <div className="flex-1">
                  <h1 className="text-2xl font-black text-white mb-2 tracking-tight">
                    Adaptive Priority Training
                  </h1>
                  <div className="flex items-center gap-2 text-sm text-white/90 mb-3">
                    <Activity size={16} />
                    <span className="font-medium">Week {weekNumber}</span>
                    <span className="text-white/60">â€¢</span>
                    <span className="text-white/80">Chaos with guardrails</span>
                  </div>
                  
                  {/* Streak display */}
                  {stats.currentStreak > 0 && (
                    <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/10 backdrop-blur-sm border border-white/20">
                      <span className="text-lg">ðŸ”¥</span>
                      <span className="text-sm font-bold text-white">
                        {stats.currentStreak} week streak!
                      </span>
                    </div>
                  )}
                </div>
                
                <div className="flex flex-col items-end gap-2">
                  <button
                    onClick={() => setCurrentView('settings')}
                    className="p-2.5 rounded-xl bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 transition-all active:scale-95"
                  >
                    <SettingsIcon className="text-white" size={20} />
                  </button>
                  
                  {/* Week grade badge */}
                  <div className={`px-4 py-2 rounded-xl bg-gradient-to-r ${currentWeekGrade.color} border-2 border-white/30 backdrop-blur-sm shadow-lg`}>
                    <div className="text-2xl font-black text-white text-center leading-none mb-0.5">
                      {currentWeekGrade.grade}
                    </div>
                    <div className="text-[9px] font-semibold text-white/90 text-center uppercase tracking-wide">
                      {currentWeekGrade.label}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Progress rings */}
              <div className="flex gap-2 overflow-x-auto pb-1">
                {priorities.filter(p => p.isPrimary).map(p => (
                  <div key={p.muscle} className="flex-shrink-0">
                    <ProgressRing 
                      percentage={p.percentage} 
                      size={54}
                      strokeWidth={5}
                      muscle={p.muscle}
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Structured session */}
          {structuredSession && (
            <div className="card-hover rounded-xl overflow-hidden bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 border-2 border-indigo-300 shadow-lg">
              <div className="px-5 py-4 border-b border-indigo-200 bg-white/50 backdrop-blur-sm">
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className="text-lg font-bold text-indigo-900 mb-1">
                      {structuredSession.lift} Session
                    </h3>
                    <p className="text-sm text-indigo-700">
                      Built from your top prioritiesâ€”ready to crush it! ðŸ’ª
                    </p>
                  </div>
                  <button
                    onClick={() => setStructuredSession(null)}
                    className="px-3 py-1.5 text-xs font-semibold border-2 border-indigo-300 rounded-lg hover:bg-indigo-100 text-indigo-800 transition-all active:scale-95"
                  >
                    Clear
                  </button>
                </div>
              </div>
              <div className="p-4 space-y-3">
                <ExerciseCard rec={structuredSession.tier1} />
                {structuredSession.tier2 && <ExerciseCard rec={structuredSession.tier2} />}
                {structuredSession.tier3 && <ExerciseCard rec={structuredSession.tier3} />}
                {structuredSession.tier4 && <ExerciseCard rec={structuredSession.tier4} />}
              </div>
            </div>
          )}

          {/* Weekly at-a-glance strip */}
          <div className="bg-white rounded-lg shadow p-3">
            <h3 className="text-[11px] font-bold text-gray-900 mb-2">
              Weekly Checkpoint
            </h3>
            <div className="flex flex-wrap gap-2">
              {priorities
                .filter(p => p.isPrimary)
                .map(p => {
                  let bg = 'bg-rose-500';
                  if (p.percentage >= 100) bg = 'bg-emerald-500';
                  else if (p.percentage >= 75) bg = 'bg-lime-500';
                  else if (p.percentage >= 50) bg = 'bg-amber-500';

                  return (
                    <div
                      key={p.muscle}
                      className="flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-gray-100"
                    >
                      <span className={`w-2 h-2 rounded-full ${bg}`} />
                      <span className="capitalize">{p.muscle}</span>
                      <span className="text-gray-600">
                        {p.current.toFixed(1)}/{medTarget}
                      </span>
                    </div>
                  );
                })}
            </div>
          </div>

          {/* Main priorities */}
          {!structuredSession && (
            <>
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
                <div className="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                  <div className="flex items-center gap-2.5 mb-2">
                    <div className="p-2 rounded-lg bg-primary-100">
                      <TrendingUp className="text-primary-600" size={20} />
                    </div>
                    <h2 className="text-lg font-bold text-slate-900">
                      Today's Priorities
                    </h2>
                  </div>
                  <p className="text-sm text-slate-600 leading-relaxed">
                    Movement categories ranked by weekly need. Tap to expand and see progress + exercises.
                  </p>
                </div>

                {accessoryNeeds.length > 0 && (
                  <div className="px-5 py-3 bg-amber-50 border-b border-amber-100">
                    <p className="text-sm text-amber-900 leading-relaxed">
                      <span className="font-semibold">ðŸŽ¯ Accessory gaps: </span>
                      {accessoryNeeds.map((p, i) => (
                        <span key={p.muscle}>
                          {i > 0 && ', '}
                          <span className="capitalize font-medium">{p.muscle}</span>
                          <span className="text-amber-700"> ({p.remaining.toFixed(1)} sets)</span>
                        </span>
                      ))}
                    </p>
                  </div>
                )}

                <div className="p-4">
                  <button
                    type="button"
                    onClick={buildPrioritySessionFromTopRecs}
                    className="w-full btn-primary text-white px-4 py-3.5 rounded-xl text-sm font-bold shadow-md flex items-center justify-center gap-2 active:scale-98 mb-4"
                  >
                    <Zap size={20} />
                    <span>Build Session from Top Priorities</span>
                  </button>

                  <div className="space-y-4">
                    {sortedCategories.map(([catKey, bucket]) => (
                      <CategoryCard
                        key={catKey}
                        catKey={catKey}
                        bucket={bucket}
                      />
                    ))}
                  </div>

                  <button
                    type="button"
                    onClick={() => setShowQuickAdd(true)}
                    className="w-full mt-4 inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white text-sm font-bold hover:from-blue-600 hover:to-cyan-600 shadow-md transition-all active:scale-98"
                  >
                    <Plus size={20} />
                    <span>Add Accessory Exercise</span>
                  </button>
                </div>
              </div>
            </>
          )}
        </div>
      );

      const ArchiveView = () => {
        const sorted = [...workoutHistory].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );
        
        const avgWorkoutsPerWeek = weeklyVolumes.length > 0
          ? (workoutHistory.length / weeklyVolumes.length).toFixed(1)
          : 0;
        
        return (
          <div className="space-y-5">
            <div className="relative overflow-hidden rounded-2xl shadow-xl">
              <div className="absolute inset-0 bg-gradient-to-br from-slate-600 via-slate-700 to-slate-800"></div>
              <div className="relative px-6 py-8">
                <h1 className="text-2xl font-black text-white mb-2 tracking-tight">
                  Workout Archive
                </h1>
                <div className="flex items-center gap-2 text-sm text-white/90">
                  <ArchiveIcon size={16} />
                  <span className="font-medium">{sorted.length} total workouts logged</span>
                </div>
              </div>
            </div>

            {/* Stats Overview */}
            <div className="grid grid-cols-2 gap-3">
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md p-4">
                <div className="text-3xl font-black text-primary-600 mb-1">
                  {stats.totalWorkouts}
                </div>
                <div className="text-xs font-semibold text-slate-600">Total Workouts</div>
              </div>
              
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md p-4">
                <div className="text-3xl font-black text-emerald-600 mb-1">
                  {stats.totalSets}
                </div>
                <div className="text-xs font-semibold text-slate-600">Total Sets</div>
              </div>
              
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md p-4">
                <div className="text-3xl font-black text-purple-600 mb-1">
                  {stats.currentStreak}
                </div>
                <div className="text-xs font-semibold text-slate-600">Week Streak</div>
              </div>
              
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md p-4">
                <div className="text-3xl font-black text-orange-600 mb-1">
                  {avgWorkoutsPerWeek}
                </div>
                <div className="text-xs font-semibold text-slate-600">Workouts/Week</div>
              </div>
            </div>

            {/* Personal Bests */}
            {Object.keys(personalBests).length > 0 && (
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
                <div className="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-yellow-50 to-orange-50">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ðŸ†</span>
                    <h2 className="text-lg font-bold text-slate-900">Personal Bests</h2>
                  </div>
                  <p className="text-xs text-slate-600 mt-1">Highest weekly volume per muscle</p>
                </div>
                <div className="p-4 grid grid-cols-2 gap-2">
                  {Object.entries(personalBests)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 6)
                    .map(([muscle, volume]) => (
                      <div key={muscle} className="bg-gradient-to-br from-yellow-50 to-orange-50 border border-orange-200 rounded-lg p-3">
                        <div className="text-xs font-semibold text-slate-600 capitalize mb-1">
                          {muscle}
                        </div>
                        <div className="text-xl font-black text-orange-600">
                          {volume.toFixed(1)}
                        </div>
                        <div className="text-[10px] text-slate-500">sets/week</div>
                      </div>
                    ))}
                </div>
              </div>
            )}

            {/* Achievements */}
            <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
              <div className="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-purple-50 to-pink-50">
                <div className="flex items-center gap-2">
                  <Award className="text-purple-600" size={20} />
                  <h2 className="text-lg font-bold text-slate-900">Achievements</h2>
                </div>
                <p className="text-xs text-slate-600 mt-1">
                  {Object.keys(achievements).length} of {Object.keys(achievementDefinitions).length} unlocked
                </p>
              </div>
              <div className="p-4 grid grid-cols-3 gap-3">
                {Object.entries(achievementDefinitions).map(([key, def]) => {
                  const unlocked = achievements[key];
                  return (
                    <div
                      key={key}
                      className={`text-center p-3 rounded-lg border-2 transition-all ${
                        unlocked
                          ? 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-300 achievement-unlock'
                          : 'bg-slate-50 border-slate-200 opacity-50'
                      }`}
                    >
                      <div className="text-3xl mb-1">{def.icon}</div>
                      <div className="text-[10px] font-bold text-slate-900 leading-tight">
                        {def.label}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Recent activity */}
            <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
              <div className="px-5 py-4 border-b border-slate-100 bg-slate-50">
                <h2 className="text-lg font-bold text-slate-900">Recent Activity</h2>
              </div>
              <div className="p-4">
                {sorted.length === 0 && (
                  <div className="text-center py-12">
                    <ArchiveIcon className="mx-auto mb-3 text-slate-300" size={48} />
                    <p className="text-slate-600 text-sm">No workouts logged yet</p>
                  </div>
                )}
                <div className="space-y-2">
                  {sorted.slice(0, 10).map(w => {
                    const d = new Date(w.date);
                    return (
                      <div
                        key={w.id}
                        className="card-hover border border-slate-200 rounded-lg px-4 py-3 bg-slate-50"
                      >
                        <div className="flex justify-between items-start mb-1.5">
                          <span className="font-bold text-slate-900">{w.exercise}</span>
                          <span className="text-xs text-slate-500">
                            {d.toLocaleDateString()}{' '}
                            {d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                        <div className="text-sm text-slate-700">
                          <span className="font-semibold text-primary-600">{w.sets} sets</span> â€¢ {w.variant}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const TrendsView = () => {
        const mesocycleAvg = getMesocycleAverage();
        
        return (
          <div className="space-y-5">
            <div className="relative overflow-hidden rounded-2xl shadow-xl">
              <div className="absolute inset-0 bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600"></div>
              <div className="relative px-6 py-8">
                <h1 className="text-2xl font-black text-white mb-2 tracking-tight">
                  Mesocycle Trends
                </h1>
                <div className="flex items-center gap-2 text-sm text-white/90">
                  <Activity size={16} />
                  <span className="font-medium">{weeklyVolumes.length} weeks of data</span>
                </div>
              </div>
            </div>

            {/* 6-Week Averages */}
            <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
              <div className="px-5 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                <h2 className="text-lg font-bold text-slate-900 mb-1">
                  6-Week Mesocycle Averages
                </h2>
                <p className="text-sm text-slate-600">
                  Chronic deficit = &lt; {(medTarget * 0.8).toFixed(0)} sets/week average
                </p>
              </div>
              
              <div className="p-5 space-y-4">
                <div>
                  <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 mb-3">
                    Primary Compounds
                  </h3>
                  {priorities.filter(p => p.isPrimary).map(p => {
                    const avg = mesocycleAvg[p.muscle] || 0;
                    const isChronicDeficit = avg < (medTarget * 0.8);
                    const percentage = (avg / medTarget) * 100;
                    
                    return (
                      <div key={p.muscle} className={`mb-3 p-3 rounded-lg border-2 ${
                        isChronicDeficit ? 'bg-rose-50 border-rose-300' : 'bg-slate-50 border-slate-200'
                      }`}>
                        <div className="flex justify-between items-center mb-2">
                          <span className={`font-bold capitalize ${
                            isChronicDeficit ? 'text-rose-700' : 'text-slate-800'
                          }`}>
                            {p.muscle}
                            {isChronicDeficit && ' âš ï¸'}
                          </span>
                          <span className={`text-lg font-bold ${
                            isChronicDeficit ? 'text-rose-600' :
                            avg >= medTarget ? 'text-emerald-600' : 'text-amber-600'
                          }`}>
                            {avg.toFixed(1)}
                          </span>
                        </div>
                        
                        <div className="w-full bg-slate-200 rounded-full h-2 mb-2">
                          <div
                            className={`progress-bar h-2 rounded-full ${
                              isChronicDeficit ? 'bg-gradient-to-r from-rose-500 to-red-500' :
                              percentage >= 100 ? 'bg-gradient-to-r from-emerald-500 to-teal-500' : 
                              'bg-gradient-to-r from-amber-500 to-orange-500'
                            }`}
                            style={{ width: `${Math.min(percentage, 100)}%` }}
                          />
                        </div>
                        
                        <div className="flex justify-between text-xs text-slate-600">
                          <span>6-week average</span>
                          <span>{percentage.toFixed(0)}% of target</span>
                        </div>
                        
                        {isChronicDeficit && (
                          <div className="mt-2 text-xs text-rose-700 font-medium">
                            âš ï¸ CHRONIC DEFICIT - Prioritize this muscle!
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                
                <div>
                  <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 mb-3">
                    Accessories
                  </h3>
                  {priorities.filter(p => !p.isPrimary).map(p => {
                    const avg = mesocycleAvg[p.muscle] || 0;
                    const percentage = (avg / medTarget) * 100;
                    
                    return (
                      <div key={p.muscle} className="mb-3 p-3 rounded-lg border-2 bg-blue-50 border-blue-200">
                        <div className="flex justify-between items-center mb-2">
                          <span className="font-bold capitalize text-blue-800">
                            {p.muscle}
                          </span>
                          <span className={`text-lg font-bold ${
                            avg >= medTarget ? 'text-emerald-600' : 'text-blue-600'
                          }`}>
                            {avg.toFixed(1)}
                          </span>
                        </div>
                        
                        <div className="w-full bg-blue-100 rounded-full h-2 mb-2">
                          <div
                            className={`progress-bar h-2 rounded-full ${
                              percentage >= 100 ? 'bg-gradient-to-r from-emerald-500 to-teal-500' : 
                              'bg-gradient-to-r from-blue-400 to-cyan-400'
                            }`}
                            style={{ width: `${Math.min(percentage, 100)}%` }}
                          />
                        </div>
                        
                        <div className="flex justify-between text-xs text-blue-700">
                          <span>6-week average</span>
                          <span>{percentage.toFixed(0)}% of target</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {/* Week-by-Week History */}
            {weeklyVolumes.length > 0 && (
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
                <div className="px-5 py-4 border-b border-slate-100 bg-slate-50">
                  <h2 className="text-lg font-bold text-slate-900">Week-by-Week Progress</h2>
                </div>
                
                <div className="p-4 space-y-3">
                  {weeklyVolumes.map((week, index) => {
                    const weekDate = new Date(week.weekStart);
                    const isCurrentWeek = weekDate.getTime() === currentWeekStart.getTime();
                    const weeksAgo = weeklyVolumes.length - index - 1;
                    
                    return (
                      <div key={week.weekStart} className={`p-4 rounded-lg border-2 ${
                        isCurrentWeek ? 'bg-blue-50 border-blue-300' : 'bg-slate-50 border-slate-200'
                      }`}>
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <div className="font-bold text-slate-800">
                              {isCurrentWeek ? 'Current Week' : `${weeksAgo} week${weeksAgo === 1 ? '' : 's'} ago`}
                            </div>
                            <div className="text-xs text-slate-500">
                              {weekDate.toLocaleDateString()}
                            </div>
                          </div>
                          {week.grade && (
                            <div className={`px-3 py-1.5 rounded-full bg-gradient-to-r ${week.grade.color} text-white text-sm font-bold`}>
                              {week.grade.grade}
                            </div>
                          )}
                        </div>
                        
                        <div className="grid grid-cols-3 gap-2">
                          {muscleGroups.primary.map(muscle => {
                            const volume = week.volumes[muscle] || 0;
                            const metTarget = volume >= medTarget;
                            
                            return (
                              <div key={muscle} className="text-center p-2 bg-white rounded border border-slate-200">
                                <div className="text-xs capitalize text-slate-600 mb-1">{muscle}</div>
                                <div className={`font-bold text-sm ${metTarget ? 'text-emerald-600' : 'text-slate-400'}`}>
                                  {volume.toFixed(1)}
                                  {metTarget && ' âœ“'}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {weeklyVolumes.length === 0 && (
              <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md p-12 text-center">
                <Activity className="mx-auto mb-3 text-slate-300" size={48} />
                <h3 className="text-lg font-bold text-slate-700 mb-2">No Trend Data Yet</h3>
                <p className="text-sm text-slate-600">
                  Start logging workouts to see your mesocycle trends and identify chronic deficits.
                </p>
              </div>
            )}
          </div>
        );
      };

      const SettingsView = () => (
        <div className="space-y-5">
          <div className="relative overflow-hidden rounded-2xl shadow-xl">
            <div className="absolute inset-0 bg-gradient-to-br from-slate-700 via-slate-800 to-slate-900"></div>
            <div className="relative px-6 py-8">
              <h1 className="text-2xl font-black text-white mb-2 tracking-tight">
                Settings
              </h1>
              <p className="text-sm text-white/80">
                Customize your MED targets and training preferences
              </p>
            </div>
          </div>

          <div className="card-hover rounded-xl bg-white border border-slate-200 shadow-md overflow-hidden">
            <div className="px-5 py-4 border-b border-slate-100 bg-slate-50">
              <h2 className="text-lg font-bold text-slate-900">Training Parameters</h2>
            </div>
            <div className="p-5 space-y-6">
              <div>
                <label className="block text-sm font-bold text-slate-900 mb-2">
                  MED Target (sets per muscle per week)
                </label>
                <input
                  type="number"
                  min="4"
                  max="20"
                  value={medTarget}
                  onChange={e => setMedTarget(Number(e.target.value) || medTarget)}
                  className="w-32 border-2 border-slate-300 rounded-lg px-4 py-2.5 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 transition-all"
                />
                <p className="text-sm text-slate-600 mt-2 leading-relaxed">
                  Minimum Effective Dose for both primary and accessory muscles. Research suggests 8-12 sets/week for optimal growth.
                </p>
              </div>

              <div>
                <label className="block text-sm font-bold text-slate-900 mb-2">
                  Strength Cycle (days)
                </label>
                <input
                  type="number"
                  min="7"
                  max="30"
                  value={strengthCycleDays}
                  onChange={e =>
                    setStrengthCycleDays(Number(e.target.value) || strengthCycleDays)
                  }
                  className="w-32 border-2 border-slate-300 rounded-lg px-4 py-2.5 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 transition-all"
                />
                <p className="text-sm text-slate-600 mt-2 leading-relaxed">
                  Frequency for practicing main lifts (Squat, Bench, Deadlift). Keep motor patterns sharp every 7-21 days.
                </p>
              </div>

              <div className="border-t border-slate-200 pt-6">
                <h3 className="text-sm font-bold text-slate-900 mb-2">Training Philosophy</h3>
                <div className="prose prose-sm text-slate-600 leading-relaxed space-y-2">
                  <p>
                    <strong className="text-slate-900">Adaptive Priority Training</strong> focuses on the Big 6 primary muscles 
                    (chest, lats, upper back, quads, glutes, hamstrings) while organizing exercises by movement categories 
                    (Press, Pull, Squat, Posterior Chain).
                  </p>
                  <p>
                    Accessories are tracked and surfaced when neededâ€”giving you flexibility to address gaps by choice, not algorithm.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <button
            onClick={() => setCurrentView('workout')}
            className="w-full btn-primary text-white px-4 py-3.5 rounded-xl text-sm font-bold shadow-md flex items-center justify-center gap-2 active:scale-98"
          >
            <CheckCircle size={20} />
            <span>Save & Return to Workout</span>
          </button>
        </div>
      );

      const BottomNav = () => (
        <div className="fixed bottom-0 left-0 right-0 glass-effect border-t border-slate-200 shadow-2xl z-50">
          <div className="max-w-2xl mx-auto px-2 py-3 flex justify-around">
            <button
              onClick={() => setCurrentView('workout')}
              className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-all ${
                currentView === 'workout'
                  ? 'text-primary-600 bg-primary-50'
                  : 'text-slate-400 hover:text-slate-600'
              }`}
            >
              <TrendingUp size={22} />
              <span className="text-xs font-semibold">Workout</span>
            </button>
            <button
              onClick={() => setCurrentView('archive')}
              className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-all ${
                currentView === 'archive'
                  ? 'text-primary-600 bg-primary-50'
                  : 'text-slate-400 hover:text-slate-600'
              }`}
            >
              <ArchiveIcon size={22} />
              <span className="text-xs font-semibold">Archive</span>
            </button>
            <button
              onClick={() => setCurrentView('trends')}
              className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-all ${
                currentView === 'trends'
                  ? 'text-primary-600 bg-primary-50'
                  : 'text-slate-400 hover:text-slate-600'
              }`}
            >
              <Activity size={22} />
              <span className="text-xs font-semibold">Trends</span>
            </button>
          </div>
        </div>
      );

      const QuickAddModal = () => {
        if (!showQuickAdd) return null;

        const accessoryExercises = Object.entries(exerciseLibrary)
          .filter(([_, data]) => data.category === 'accessory')
          .map(([name]) => name)
          .sort();

        const selectedData = quickAddExercise
          ? exerciseLibrary[quickAddExercise]
          : null;
        const variants = selectedData?.variants || [];
        const defaultVar =
          quickAddExercise &&
          lastUsedVariants[quickAddExercise] &&
          variants.includes(lastUsedVariants[quickAddExercise])
            ? lastUsedVariants[quickAddExercise]
            : variants[0] || '';

        const effectiveVariant = quickAddVariant || defaultVar;

        return (
          <div className="fixed inset-0 bg-black/50 modal-overlay flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto shadow-2xl">
              <div className="sticky top-0 px-5 py-4 border-b border-slate-200 bg-white z-10 rounded-t-2xl">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-bold text-slate-900">Add Accessory</h3>
                  <button
                    onClick={() => {
                      setShowQuickAdd(false);
                      setQuickAddExercise('');
                      setQuickAddVariant('');
                      setQuickAddSets(3);
                    }}
                    className="text-slate-400 hover:text-slate-600 font-bold text-xl transition-colors"
                  >
                    âœ•
                  </button>
                </div>
              </div>

              <div className="p-5 space-y-4">
                <div>
                  <label className="block text-sm font-bold text-slate-900 mb-2">
                    Exercise
                  </label>
                  <select
                    value={quickAddExercise}
                    onChange={e => {
                      const value = e.target.value;
                      setQuickAddExercise(value);
                      if (value) {
                        const ex = exerciseLibrary[value];
                        const v = ex.variants || [];
                        const autoVar =
                          lastUsedVariants[value] && v.includes(lastUsedVariants[value])
                            ? lastUsedVariants[value]
                            : v[0] || '';
                        setQuickAddVariant(autoVar);
                      } else {
                        setQuickAddVariant('');
                      }
                    }}
                    className="w-full border-2 border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-white transition-all"
                  >
                    <option value="">Select an accessory...</option>
                    {accessoryExercises.map(name => (
                      <option key={name} value={name}>
                        {name}
                      </option>
                    ))}
                  </select>
                </div>

                {quickAddExercise && (
                  <>
                    <div>
                      <label className="block text-sm font-bold text-slate-900 mb-2">
                        Variation
                      </label>
                      <select
                        value={effectiveVariant}
                        onChange={e => setQuickAddVariant(e.target.value)}
                        className="w-full border-2 border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-white transition-all"
                      >
                        {variants.map(v => (
                          <option key={v} value={v}>
                            {v}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-bold text-slate-900 mb-2">
                        Sets
                      </label>
                      <div className="flex items-center justify-center gap-4">
                        <button
                          type="button"
                          onClick={() => setQuickAddSets(s => Math.max(1, s - 1))}
                          className="p-3 border-2 border-slate-300 rounded-lg hover:bg-slate-50 hover:border-slate-400 transition-all active:scale-95"
                        >
                          <Minus className="text-slate-600" size={20} />
                        </button>
                        <span className="text-3xl font-bold min-w-[4rem] text-center text-slate-900">
                          {quickAddSets}
                        </span>
                        <button
                          type="button"
                          onClick={() => setQuickAddSets(s => Math.min(10, s + 1))}
                          className="p-3 border-2 border-slate-300 rounded-lg hover:bg-slate-50 hover:border-slate-400 transition-all active:scale-95"
                        >
                          <Plus className="text-slate-600" size={20} />
                        </button>
                      </div>
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        if (!quickAddExercise || !effectiveVariant) return;
                        logWorkout(quickAddExercise, effectiveVariant, quickAddSets);
                        setShowQuickAdd(false);
                        setQuickAddExercise('');
                        setQuickAddVariant('');
                        setQuickAddSets(3);
                      }}
                      className="w-full inline-flex items-center justify-center gap-2 px-4 py-3.5 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-bold hover:from-emerald-600 hover:to-teal-600 shadow-md transition-all active:scale-98"
                    >
                      <CheckCircle size={20} />
                      <span>Log {quickAddSets} sets of {effectiveVariant}</span>
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      const AlmostDoneModal = () => {
        if (!showAlmostDone) return null;

        const handleQuickFinish = (suggestion, exercise) => {
          const setsNeeded = Math.ceil(parseFloat(suggestion.remaining));
          const variant = exercise.variants[0];
          
          logWorkout(exercise.exercise, variant, setsNeeded);
          setShowAlmostDone(false);
          setAlmostDoneSuggestions([]);
        };

        return (
          <div className="fixed inset-0 bg-black/50 modal-overlay flex items-center justify-center z-50 p-4">
            <div className="bg-gradient-to-br from-yellow-50 via-orange-50 to-pink-50 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto shadow-2xl border-2 border-orange-300">
              <div className="sticky top-0 px-5 py-4 border-b border-orange-200 bg-white/80 backdrop-blur-sm z-10 rounded-t-2xl">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <span className="text-2xl">ðŸŽ¯</span>
                    <h3 className="text-lg font-bold text-orange-900">Almost There!</h3>
                  </div>
                  <button
                    onClick={() => {
                      setShowAlmostDone(false);
                      setAlmostDoneSuggestions([]);
                    }}
                    className="text-orange-400 hover:text-orange-600 font-bold text-xl transition-colors"
                  >
                    âœ•
                  </button>
                </div>
              </div>

              <div className="p-5 space-y-4">
                <p className="text-sm text-orange-900 leading-relaxed">
                  You're super close to hitting your weekly targets! Want to finish strong? ðŸ’ª
                </p>
                
                {almostDoneSuggestions.map(suggestion => (
                  <div key={suggestion.muscle} className="bg-white rounded-xl p-4 border-2 border-orange-200 shadow-sm">
                    <div className="flex items-center justify-between mb-3">
                      <div>
                        <h4 className="font-bold text-slate-900 capitalize text-base">
                          {suggestion.muscle}
                        </h4>
                        <p className="text-xs text-orange-700 font-medium">
                          Just {suggestion.remaining} sets away!
                        </p>
                      </div>
                      <div className="text-2xl">
                        {suggestion.remaining === '1.0' ? 'ðŸ”¥' : 'âš¡'}
                      </div>
                    </div>
                    
                    <div className="space-y-2">
                      <p className="text-xs font-semibold text-slate-600 mb-1">Quick finishers:</p>
                      {suggestion.exercises.map(ex => (
                        <button
                          key={ex.exercise}
                          onClick={() => handleQuickFinish(suggestion, ex)}
                          className="w-full text-left px-3 py-2.5 bg-gradient-to-r from-orange-100 to-yellow-100 hover:from-orange-200 hover:to-yellow-200 rounded-lg border border-orange-200 transition-all active:scale-98"
                        >
                          <div className="flex justify-between items-center">
                            <span className="text-sm font-semibold text-slate-900">
                              {ex.exercise}
                            </span>
                            <span className="text-xs font-bold text-orange-600">
                              {Math.ceil(parseFloat(suggestion.remaining))} set{Math.ceil(parseFloat(suggestion.remaining)) > 1 ? 's' : ''}
                            </span>
                          </div>
                          <div className="text-xs text-slate-600 mt-0.5">
                            {ex.variants[0]}
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
                
                <button
                  onClick={() => {
                    setShowAlmostDone(false);
                    setAlmostDoneSuggestions([]);
                  }}
                  className="w-full px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-semibold text-sm transition-all"
                >
                  Maybe Later
                </button>
              </div>
            </div>
          </div>
        );
      };

      const Toast = ({ toast }) => {
        const bgColor = toast.type === 'achievement' 
          ? 'bg-gradient-to-r from-purple-500 to-pink-500' 
          : toast.type === 'celebration'
          ? 'bg-gradient-to-r from-emerald-500 to-teal-500'
          : 'bg-gradient-to-r from-blue-500 to-cyan-500';
        
        return (
          <div className={`toast flex items-center gap-3 ${bgColor} text-white px-4 py-3 rounded-xl shadow-lg backdrop-blur-sm border border-white/20`}>
            <span className="text-2xl">{toast.icon}</span>
            <span className="text-sm font-semibold">{toast.message}</span>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 pb-24">
          <div className="max-w-2xl mx-auto px-4 py-6">
            {currentView === 'workout' && <WorkoutView />}
            {currentView === 'archive' && <ArchiveView />}
            {currentView === 'trends' && <TrendsView />}
            {currentView === 'settings' && <SettingsView />}
          </div>
          <BottomNav />
          <QuickAddModal />
          <AlmostDoneModal />
          
          {/* Toast container */}
          <div className="fixed top-4 right-4 z-[100] space-y-2">
            {toasts.map(toast => (
              <Toast key={toast.id} toast={toast} />
            ))}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App />);
  </script>
</body>
</html>
