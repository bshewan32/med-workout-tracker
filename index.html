<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MED Workout Tracker – Chaos with Guardrails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .progress-bar { transition: width 0.3s ease-in-out; }
    .modal-overlay { backdrop-filter: blur(2px); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- Data -----------------------------------------------------------------

    const exerciseLibrary = {
      // Big 3 / main primaries
      'Squats': {
        muscles: { quads: 1, glutes: 0.6, core: 0.3 },
        category: 'primary',
        movementCategory: 'squat',
        variants: ['Back Squat', 'Front Squat', 'Safety Bar Squat', 'Hack Squat', 'Pendulum Squat', 'Goblet Squat']
      },
      'Bench Press': {
        muscles: { chest: 1, triceps: 0.6, shoulders: 0.4 },
        category: 'primary',
        movementCategory: 'press',
        variants: ['Flat Barbell Bench', 'Incline Bench', 'Close Grip Bench', 'Dumbbell Press', 'Machine Press']
      },
      'Deadlifts': {
        muscles: { glutes: 1, hamstrings: 1, upperBack: 0.6, core: 0.4 },
        category: 'primary',
        movementCategory: 'posterior',
        variants: ['Conventional Deadlift', 'Sumo Deadlift', 'Trap Bar Deadlift', 'Romanian Deadlift', 'Deficit Deadlift']
      },

      // Other primaries
      'Rows': {
        muscles: { upperBack: 1, lats: 0.6, biceps: 0.4 },
        category: 'primary',
        movementCategory: 'pull',
        variants: ['Barbell Row', 'Dumbbell Row', 'Chest-Supported Row', 'Cable Row']
      },
      'Pull-ups': {
        muscles: { lats: 1, upperBack: 0.4, biceps: 0.6 },
        category: 'primary',
        movementCategory: 'pull',
        variants: ['Pull-ups', 'Chin-ups', 'Neutral Grip', 'Band-Assisted Pull-ups', 'Lat Pulldown']
      },
      'Leg Press': {
        muscles: { quads: 1, glutes: 0.4 },
        category: 'primary',
        movementCategory: 'squat',
        variants: ['Leg Press', 'Single-Leg Press', 'Hack Squat Machine']
      },
      'Lunges': {
        muscles: { quads: 1, glutes: 0.6 },
        category: 'primary',
        movementCategory: 'squat',
        variants: ['Walking Lunges', 'Reverse Lunges', 'Bulgarian Split Squats', 'Static Lunges']
      },
      'Hip Thrusts': {
        muscles: { glutes: 1, hamstrings: 0.4 },
        category: 'primary',
        movementCategory: 'posterior',
        variants: ['Barbell Hip Thrust', 'Dumbbell Hip Thrust', 'Single-Leg Hip Thrust']
      },

      // Accessories – tracked separately
      'Leg Curls': {
        muscles: { hamstrings: 1 },
        category: 'accessory',
        movementCategory: 'posterior',
        variants: ['Lying Leg Curl', 'Seated Leg Curl', 'Nordic Curl']
      },
      'Leg Extensions': {
        muscles: { quads: 1 },
        category: 'accessory',
        movementCategory: 'squat',
        variants: ['Leg Extension Machine', 'Single-Leg Extension']
      },
      'Bicep Curls': {
        muscles: { biceps: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Barbell Curl', 'Dumbbell Curl', 'Hammer Curl', 'Cable Curl']
      },
      'Tricep Extensions': {
        muscles: { triceps: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Rope Pushdown', 'Overhead Extension', 'Skullcrushers', 'Kickbacks']
      },
      'Lateral Raises': {
        muscles: { shoulders: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Dumbbell Lateral Raise', 'Cable Lateral Raise', 'Machine Lateral Raise']
      },
      'Face Pulls': {
        muscles: { upperBack: 0.6, shoulders: 0.6 },
        category: 'accessory',
        movementCategory: 'pull',
        variants: ['Rope Face Pulls', 'Cable High Row']
      },
      'Calf Raises': {
        muscles: { calves: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Standing Calf Raises', 'Seated Calf Raises', 'Leg Press Calf Raises']
      },
      'Crunches': {
        muscles: { core: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Floor Crunch', 'Cable Crunch', 'Reverse Crunch']
      },
      'Planks': {
        muscles: { core: 1 },
        category: 'accessory',
        movementCategory: 'accessory',
        variants: ['Front Plank', 'Side Plank', 'Weighted Plank']
      },
      'Back Extensions': {
        muscles: { glutes: 0.6, hamstrings: 0.6, core: 0.4 },
        category: 'accessory',
        movementCategory: 'posterior',
        variants: ['Back Extensions', 'Reverse Hyper']
      }
    };

    const muscleGroups = {
      primary: ['chest', 'lats', 'upperBack', 'quads', 'glutes', 'hamstrings'],
      accessory: ['shoulders', 'biceps', 'triceps', 'calves', 'core']
    };

    const allMuscles = [...muscleGroups.primary, ...muscleGroups.accessory];

    const majorLifts = {
      'Squats': ['quads', 'glutes'],
      'Bench Press': ['chest', 'triceps'],
      'Deadlifts': ['glutes', 'hamstrings', 'upperBack']
    };

    const movementCategoryMeta = {
      pull: {
        label: 'Pull',
        subtitle: 'Rows, pulldowns, pull-ups',
        description: 'Upper back and lat work – your main pulling patterns.'
      },
      squat: {
        label: 'Squat',
        subtitle: 'Squats, lunges, leg press',
        description: 'Knee-dominant lower body work – quads and glutes.'
      },
      press: {
        label: 'Press',
        subtitle: 'Bench, incline, push-ups',
        description: 'Chest pressing patterns – chest, triceps, shoulders.'
      },
      posterior: {
        label: 'Posterior Chain',
        subtitle: 'Deadlifts, RDLs, hip thrusts',
        description: 'Hinges and hamstring work – glutes and hamstrings.'
      }
    };

    // Icons
    const ChevronDown = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 12 15 18 9" />
      </svg>
    );
    const ChevronUp = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="18 15 12 9 6 15" />
      </svg>
    );
    const TrendingUp = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
        <polyline points="17 6 23 6 23 12" />
      </svg>
    );
    const SettingsIcon = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="3" />
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83" />
      </svg>
    );
    const AlertCircle = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>
    );
    const CheckCircle = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
        <polyline points="22 4 12 14.01 9 11.01" />
      </svg>
    );
    const Plus = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );
    const Minus = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    );
    const Zap = ({ size = 16 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
      </svg>
    );
    const ArchiveIcon = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="4" width="18" height="4" />
        <path d="M5 8v10h14V8" />
        <line x1="10" y1="12" x2="14" y2="12" />
      </svg>
    );

    // Helpers
    const getWeekStart = (date = new Date()) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day;
      const weekStart = new Date(d.setDate(diff));
      weekStart.setHours(0, 0, 0, 0);
      return weekStart;
    };

    const daysBetween = (a, b) => {
      const ms = Math.abs(a - b);
      return Math.floor(ms / (1000 * 60 * 60 * 24));
    };

    const App = () => {
      const [currentView, setCurrentView] = useState('workout');
      const [workoutHistory, setWorkoutHistory] = useState(() => {
        const saved = localStorage.getItem('medApp_workoutHistory');
        return saved ? JSON.parse(saved) : [];
      });
      const [lastStrengthWorkout, setLastStrengthWorkout] = useState(() => {
        const saved = localStorage.getItem('medApp_lastStrengthWorkout');
        return saved ? JSON.parse(saved) : {};
      });
      const [medTarget, setMedTarget] = useState(() => {
        const saved = localStorage.getItem('medApp_medTarget');
        return saved ? parseInt(saved) : 10;
      });
      const [strengthCycleDays, setStrengthCycleDays] = useState(() => {
        const saved = localStorage.getItem('medApp_strengthCycleDays');
        return saved ? parseInt(saved) : 14;
      });
      const [lastUsedVariants, setLastUsedVariants] = useState(() => {
        const saved = localStorage.getItem('medApp_lastUsedVariants');
        return saved ? JSON.parse(saved) : {};
      });

      //const [expandedExercise, setExpandedExercise] = useState(null);
      const [selectedVariants, setSelectedVariants] = useState({});
      const [setSets, setSetSets] = useState({});
      const [structuredSession, setStructuredSession] = useState(null);

      const [showQuickAdd, setShowQuickAdd] = useState(false);
      const [quickAddExercise, setQuickAddExercise] = useState('');
      const [quickAddVariant, setQuickAddVariant] = useState('');
      const [quickAddSets, setQuickAddSets] = useState(3);

      const [currentWeekStart] = useState(() => getWeekStart());

      // Persist
      useEffect(() => {
        localStorage.setItem('medApp_workoutHistory', JSON.stringify(workoutHistory));
      }, [workoutHistory]);
      useEffect(() => {
        localStorage.setItem('medApp_lastStrengthWorkout', JSON.stringify(lastStrengthWorkout));
      }, [lastStrengthWorkout]);
      useEffect(() => {
        localStorage.setItem('medApp_medTarget', medTarget.toString());
      }, [medTarget]);
      useEffect(() => {
        localStorage.setItem('medApp_strengthCycleDays', strengthCycleDays.toString());
      }, [strengthCycleDays]);
      useEffect(() => {
        localStorage.setItem('medApp_lastUsedVariants', JSON.stringify(lastUsedVariants));
      }, [lastUsedVariants]);

      // Init sets
      useEffect(() => {
        const initial = {};
        Object.keys(exerciseLibrary).forEach(name => {
          initial[name] = 3;
        });
        setSetSets(initial);
      }, []);

      // Volumes / priorities --------------------------------------------------

      const getCurrentWeekWorkouts = () => {
        const end = new Date(currentWeekStart);
        end.setDate(end.getDate() + 7);
        return workoutHistory.filter(w => {
          const d = new Date(w.date);
          return d >= currentWeekStart && d < end;
        });
      };

      const calculateCurrentWeekVolume = () => {
        const volume = {};
        allMuscles.forEach(m => (volume[m] = 0));
        getCurrentWeekWorkouts().forEach(w => {
          const ex = exerciseLibrary[w.exercise];
          if (!ex) return;
          Object.entries(ex.muscles).forEach(([muscle, mult]) => {
            if (!allMuscles.includes(muscle)) return;
            volume[muscle] += w.sets * mult;
          });
        });
        return volume;
      };

      const getMuscleGroupPriorities = () => {
        const current = calculateCurrentWeekVolume();
        return allMuscles
          .map(muscle => {
            const currentVol = current[muscle] || 0;
            const remaining = Math.max(0, medTarget - currentVol);
            const percentage = medTarget > 0 ? (currentVol / medTarget) * 100 : 0;
            const isPrimary = muscleGroups.primary.includes(muscle);
            const priority = remaining * (isPrimary ? 2 : 1);
            return {
              muscle,
              current: currentVol,
              remaining,
              percentage,
              isPrimary,
              priority
            };
          })
          .sort((a, b) => b.priority - a.priority);
      };

      const getSmartRecommendations = () => {
        const priorities = getMuscleGroupPriorities();
        const currentWeekVolume = calculateCurrentWeekVolume();

        const topNeeds = priorities
          .filter(p => p.isPrimary && p.remaining > 0)
          .slice(0, 6);

        const recs = [];

        Object.entries(exerciseLibrary).forEach(([exercise, data]) => {
          if (data.category === 'accessory') return; // accessories don't drive smart recs

          let score = 0;
          const targets = [];

          topNeeds.forEach(need => {
            const muscleScore = data.muscles[need.muscle] || 0;
            if (muscleScore > 0) {
              const alreadyHit = (currentWeekVolume[need.muscle] || 0) > 0;
              const zeroBoost = alreadyHit ? 1.0 : 1.5;
              const weight = need.remaining * 3 * zeroBoost;
              score += muscleScore * weight;
              targets.push(need.muscle);
            }
          });

          if (score > 0) {
            const primaryMuscle =
              Object.entries(data.muscles).find(([_, s]) => s === 1)?.[0] ||
              targets[0] ||
              'mixed';

            recs.push({
              exercise,
              score: score.toFixed(1),
              targets: targets.length ? targets : [primaryMuscle],
              primaryMuscle,
              category: data.category,
              variants: data.variants,
              movementCategory: data.movementCategory || 'press'
            });
          }
        });

        // Make sure Big 3 are always present
        Object.keys(majorLifts).forEach(lift => {
          const exists = recs.some(r => r.exercise === lift);
          if (!exists && exerciseLibrary[lift]) {
            const data = exerciseLibrary[lift];
            const primaryMuscle =
              Object.entries(data.muscles).find(([_, s]) => s === 1)?.[0] ||
              'mixed';
            const targets = Object.keys(data.muscles).filter(m =>
              muscleGroups.primary.includes(m)
            );
            recs.push({
              exercise: lift,
              score: '0.1',
              targets: targets.length ? targets : [primaryMuscle],
              primaryMuscle,
              category: data.category,
              variants: data.variants,
              movementCategory: data.movementCategory || 'press'
            });
          }
        });

        return recs.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
      };

      const getStrengthRecommendation = () => {
        const now = new Date();
        const candidates = Object.keys(majorLifts).map(lift => {
          const last = lastStrengthWorkout[lift]
            ? new Date(lastStrengthWorkout[lift])
            : null;
          const daysSince = last ? daysBetween(now, last) : 999;
          return { lift, daysSince };
        });

        const overdue = candidates
          .filter(c => c.daysSince >= strengthCycleDays)
          .sort((a, b) => b.daysSince - a.daysSince);
        return overdue[0] || null;
      };

      const buildStructuredSession = liftName => {
        const smartRecs = getSmartRecommendations();
        const exclude = [liftName];

        const pickByMuscle = (muscles, category, moreExclude = []) => {
          return smartRecs.find(r =>
            ![...exclude, ...moreExclude].includes(r.exercise) &&
            r.category === category &&
            muscles.some(m => r.targets.includes(m))
          );
        };

        const base = exerciseLibrary[liftName];
        const tier1 = {
          exercise: liftName,
          score: null,
          primaryMuscle:
            Object.entries(base.muscles).find(([_, s]) => s === 1)?.[0] || 'mixed',
          category: base.category,
          variants: base.variants,
          movementCategory: base.movementCategory
        };

        let tier2 = null;
        let tier3 = null;

        if (liftName === 'Squats') {
          tier2 = pickByMuscle(['hamstrings', 'glutes'], 'primary');
          tier3 = pickByMuscle(
            ['upperBack', 'core'],
            'accessory',
            [tier2?.exercise].filter(Boolean)
          );
        } else if (liftName === 'Deadlifts') {
          tier2 = pickByMuscle(['quads'], 'primary');
          tier3 = pickByMuscle(
            ['upperBack', 'core'],
            'accessory',
            [tier2?.exercise].filter(Boolean)
          );
        } else if (liftName === 'Bench Press') {
          tier2 =
            pickByMuscle(['quads', 'glutes', 'hamstrings'], 'primary') ||
            pickByMuscle(['lats', 'upperBack'], 'primary');
          tier3 =
            pickByMuscle(
              ['lats', 'upperBack'],
              'accessory',
              [tier2?.exercise].filter(Boolean)
            ) ||
            pickByMuscle(
              muscleGroups.primary,
              'accessory',
              [tier2?.exercise].filter(Boolean)
            );
        }

        return { lift: liftName, tier1, tier2, tier3 };
      };

      // Logging ---------------------------------------------------------------

      const logWorkout = (exercise, variant, sets) => {
        const newEntry = {
          exercise,
          variant,
          sets,
          date: new Date().toISOString(),
          id: Date.now()
        };
        setWorkoutHistory(prev => [...prev, newEntry]);

        if (majorLifts[exercise]) {
          setLastStrengthWorkout(prev => ({
            ...prev,
            [exercise]: new Date().toISOString()
          }));
        }

        setLastUsedVariants(prev => ({
          ...prev,
          [exercise]: variant
        }));

        //setExpandedExercise(null);
      };

      const markStrengthWorkout = lift => {
        setLastStrengthWorkout(prev => ({
          ...prev,
          [lift]: new Date().toISOString()
        }));
      };

      // Derived ---------------------------------------------------------------

      const priorities = getMuscleGroupPriorities();
      const smartRecs = getSmartRecommendations();
      const strengthRec = getStrengthRecommendation();
      const currentWeekVolume = calculateCurrentWeekVolume();

      const weekNumber =
        Math.floor(
          (new Date() - currentWeekStart) / (1000 * 60 * 60 * 24 * 7)
        ) + 1;

      // Accessory needs strip
      const accessoryNeeds = priorities
        .filter(p => !p.isPrimary && p.remaining > 0)
        .sort((a, b) => b.remaining - a.remaining)
        .slice(0, 3);

      // Group smart recs by movement category (for Option B)
      const movementKeys = ['pull', 'squat', 'press', 'posterior'];
      const categoryBuckets = {};
      movementKeys.forEach(k => (categoryBuckets[k] = { exercises: [], score: 0 }));

      smartRecs.forEach(rec => {
        const cat = rec.movementCategory;
        if (!movementKeys.includes(cat)) return;
        categoryBuckets[cat].exercises.push(rec);
        categoryBuckets[cat].score += parseFloat(rec.score || 0);
      });

      const sortedCategories = Object.entries(categoryBuckets)
        .filter(([, bucket]) => bucket.exercises.length > 0)
        .sort((a, b) => b[1].score - a[1].score);

      // Components ------------------------------------------------------------

const ExerciseCard = ({ rec }) => {
  const [isExpanded, setIsExpanded] = React.useState(false);

  const defaultVariant =
    lastUsedVariants[rec.exercise] &&
    rec.variants?.includes(lastUsedVariants[rec.exercise])
      ? lastUsedVariants[rec.exercise]
      : rec.variants?.[0] || rec.exercise;

  const selectedVariant = selectedVariants[rec.exercise] || defaultVariant;
  const sets = setSets[rec.exercise] || 3;

  const handleToggle = () => {
    if (!isExpanded && !selectedVariants[rec.exercise]) {
      setSelectedVariants(prev => ({
        ...prev,
        [rec.exercise]: defaultVariant
      }));
    }
    setIsExpanded(prev => !prev);
  };

  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden bg-white">
      <button
        type="button"
        onClick={handleToggle}
        className="w-full text-left px-4 py-3 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200"
      >
        <div className="flex justify-between items-start mb-1">
          <div>
            <div className="text-sm font-bold text-gray-900">
              {rec.exercise}
            </div>
            <div className="text-[11px] text-gray-600">
              <span className="capitalize">{rec.primaryMuscle}</span>
              {' · '}
              {rec.category === 'primary' ? 'Compound' : 'Accessory'}
            </div>
            <div className="text-[11px] text-gray-500 mt-0.5">
              Last / suggested: <span className="font-medium">{defaultVariant}</span>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {rec.score !== null && rec.score !== undefined && (
              <span className="inline-flex items-center px-2 py-1 text-[11px] font-bold rounded-full bg-purple-600 text-white">
                {rec.score}
              </span>
            )}
            <span className="text-gray-400">
              {isExpanded ? <ChevronUp /> : <ChevronDown />}
            </span>
          </div>
        </div>
        <div className="text-[11px] text-gray-500">
          Targets: {rec.targets?.join(', ') || rec.primaryMuscle}
        </div>
      </button>

      {isExpanded && (
        <div className="px-4 py-3 border-t border-purple-200 bg-white text-xs space-y-3">
          <div>
            <label className="block mb-1 font-medium text-gray-700">
              Variation
            </label>
            <select
              value={selectedVariant}
              onChange={e =>
                setSelectedVariants(prev => ({
                  ...prev,
                  [rec.exercise]: e.target.value
                }))
              }
              className="w-full border-2 border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500 text-xs"
            >
              {rec.variants?.map(v => (
                <option key={v} value={v}>
                  {v}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label className="block mb-1 font-medium text-gray-700">
              Sets
            </label>
            <div className="flex items-center gap-3">
              <button
                type="button"
                onClick={() =>
                  setSetSets(prev => ({
                    ...prev,
                    [rec.exercise]: Math.max(1, sets - 1)
                  }))
                }
                className="px-2 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
              >
                <Minus />
              </button>
              <span className="text-sm font-semibold min-w-[2rem] text-center">
                {sets}
              </span>
              <button
                type="button"
                onClick={() =>
                  setSetSets(prev => ({
                    ...prev,
                    [rec.exercise]: Math.min(10, sets + 1)
                  }))
                }
                className="px-2 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
              >
                <Plus />
              </button>
            </div>
          </div>
          <button
            type="button"
            onClick={() => logWorkout(rec.exercise, selectedVariant, sets)}
            className="w-full inline-flex items-center justify-center px-3 py-2 rounded-md bg-green-600 text-white text-xs font-semibold hover:bg-green-700"
          >
            <CheckCircle />
            <span className="ml-2">
              Log {sets} sets of {selectedVariant}
            </span>
          </button>
        </div>
      )}
    </div>
  );
};

      const CategoryCard = ({ catKey, bucket, defaultOpen = false }) => {
        const meta = movementCategoryMeta[catKey];
        const [open, setOpen] = useState(defaultOpen);
        if (!meta) return null;

        const score = bucket.score.toFixed(1);
        const exercises = bucket.exercises.slice(0, 4); // top 3–4 lifts in that category

        return (
          <div className="border border-gray-200 rounded-lg overflow-hidden bg-white">
            <button
              type="button"
              onClick={() => setOpen(!open)}
              className="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 flex items-start justify-between"
            >
              <div>
                <div className="text-sm font-bold text-gray-900">
                  {meta.label}
                </div>
                <div className="text-[11px] text-gray-600">
                  {meta.subtitle}
                </div>
                <div className="text-[11px] text-gray-500 mt-0.5">
                  {meta.description}
                </div>
              </div>
              <div className="flex flex-col items-end gap-1">
                <span className="inline-flex items-center px-2 py-1 text-[11px] font-bold rounded-full bg-blue-600 text-white">
                  {score}
                </span>
                <span className="text-gray-400">
                  {open ? <ChevronUp /> : <ChevronDown />}
                </span>
              </div>
            </button>
            {open && (
              <div className="px-4 py-3 bg-white border-t border-gray-200 space-y-2">
                {exercises.map(rec => (
                  <ExerciseCard key={rec.exercise} rec={rec} />
                ))}
              </div>
            )}
          </div>
        );
      };

      const WorkoutView = () => (
        <div className="space-y-4">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-lg shadow">
            <div className="flex justify-between items-start">
              <div>
                <h1 className="text-xl font-bold">Adaptive Priority Training</h1>
                <p className="text-xs text-blue-100">
                  Week {weekNumber} • Chaos with guardrails
                </p>
              </div>
              <button
                onClick={() => setCurrentView('settings')}
                className="p-2 rounded-full hover:bg-blue-500/70"
              >
                <SettingsIcon />
              </button>
            </div>
          </div>

          {/* Strength reminder */}
          {strengthRec && (
            <div className="bg-orange-50 border-2 border-orange-400 rounded-lg p-4 shadow">
              <div className="flex items-start gap-3">
                <AlertCircle />
                <div className="flex-1 text-xs">
                  <div className="font-bold text-orange-900 mb-1">
                    Strength focus: {strengthRec.lift}
                  </div>
                  <div className="text-orange-800 mb-2">
                    Last logged{' '}
                    {strengthRec.daysSince === 999
                      ? 'never'
                      : `${strengthRec.daysSince} days ago`}.
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => markStrengthWorkout(strengthRec.lift)}
                      className="flex-1 px-2 py-1 rounded-md bg-orange-600 text-white hover:bg-orange-700"
                    >
                      Mark done
                    </button>
                    <button
                      onClick={() =>
                        setStructuredSession(buildStructuredSession(strengthRec.lift))
                      }
                      className="flex-1 px-2 py-1 rounded-md bg-orange-700 text-white hover:bg-orange-800 inline-flex items-center justify-center gap-1"
                    >
                      <Zap />
                      Build session
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Structured session */}
          {structuredSession && (
            <div className="bg-gradient-to-r from-indigo-50 to-indigo-100 border-2 border-indigo-400 rounded-lg p-4 shadow">
              <div className="flex justify-between items-start mb-3">
                <div>
                  <h3 className="font-bold text-indigo-900 text-sm mb-1">
                    {structuredSession.lift} Session
                  </h3>
                  <p className="text-[11px] text-indigo-700">
                    Classic main-lift day, built from your current priorities.
                  </p>
                </div>
                <button
                  onClick={() => setStructuredSession(null)}
                  className="text-[11px] px-2 py-1 border border-indigo-400 rounded-md hover:bg-indigo-200 text-indigo-800"
                >
                  Clear
                </button>
              </div>
              <div className="space-y-2">
                <ExerciseCard rec={structuredSession.tier1} />
                {structuredSession.tier2 && <ExerciseCard rec={structuredSession.tier2} />}
                {structuredSession.tier3 && <ExerciseCard rec={structuredSession.tier3} />}
              </div>
            </div>
          )}

          {/* Today’s priorities – Category cards (Option B, Layout A) */}
          {!structuredSession && (
            <>
              <div className="bg-white rounded-lg shadow p-4 space-y-3">
                <div className="flex items-center gap-2">
                  <TrendingUp />
                  <h2 className="text-sm font-bold text-gray-900">
                    Today&apos;s Priorities
                  </h2>
                </div>
                <p className="text-[11px] text-gray-600">
                  Categories are ranked by weekly need. Pick 1–2 from the top, then fill in.
                </p>

                {/* Accessory needs strip */}
                <div className="mt-2 mb-2">
                  {accessoryNeeds.length > 0 ? (
                    <p className="text-[11px] text-gray-700">
                      <span className="font-semibold">Accessory needs this week: </span>
                      {accessoryNeeds.map((p, i) => (
                        <span key={p.muscle}>
                          {i > 0 && ', '}
                          <span className="capitalize">{p.muscle}</span> (
                          {p.remaining.toFixed(1)} sets to MED)
                        </span>
                      ))}
                    </p>
                  ) : (
                    <p className="text-[11px] text-gray-500">
                      Accessories are on track or above MED for this week.
                    </p>
                  )}
                </div>

                <div className="space-y-3">
                  {sortedCategories.map(([catKey, bucket], idx) => (
                    <CategoryCard
                      key={catKey}
                      catKey={catKey}
                      bucket={bucket}
                      defaultOpen={idx === 0}
                    />
                  ))}
                </div>

                <button
                  type="button"
                  onClick={() => setShowQuickAdd(true)}
                  className="w-full mt-3 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-md bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700"
                >
                  <Plus />
                  Add Accessory Exercise
                </button>

                {!strengthRec && (
                  <div className="mt-4 pt-3 border-t border-gray-200">
                    <p className="text-[11px] text-gray-600 mb-2 font-medium">
                      Want a classic strength day instead?
                    </p>
                    <div className="flex gap-2">
                      {Object.keys(majorLifts).map(lift => (
                        <button
                          key={lift}
                          type="button"
                          onClick={() => setStructuredSession(buildStructuredSession(lift))}
                          className="flex-1 px-2 py-1 text-[11px] font-semibold rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800"
                        >
                          {lift.replace(' Press', '')}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* Weekly progress + Accessory status */}
              <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-sm font-bold text-gray-900 mb-2">
                  This Week&apos;s Progress
                </h3>
                <p className="text-[11px] text-gray-500 mb-3">
                  MED target per muscle group: {medTarget} sets.
                </p>

                {/* Primary */}
                <div className="space-y-2 mb-3">
                  {priorities
                    .filter(p => p.isPrimary)
                    .map(p => (
                      <div key={p.muscle} className="space-y-1">
                        <div className="flex justify-between text-[11px]">
                          <span className="capitalize font-medium">{p.muscle}</span>
                          <span
                            className={
                              p.current >= medTarget
                                ? 'text-green-600 font-semibold'
                                : 'text-gray-600'
                            }
                          >
                            {p.current.toFixed(1)}/{medTarget} · {Math.round(p.percentage)}%
                          </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                          <div
                            className={
                              'progress-bar h-1.5 rounded-full ' +
                              (p.percentage >= 100
                                ? 'bg-green-500'
                                : p.percentage >= 60
                                ? 'bg-yellow-500'
                                : 'bg-red-500')
                            }
                            style={{ width: `${Math.min(p.percentage, 100)}%` }}
                          />
                        </div>
                      </div>
                    ))}
                </div>

                {/* Accessory status */}
                <div className="border-t border-gray-200 pt-3">
                  <h4 className="text-[11px] font-bold text-gray-800 mb-2">
                    Accessory Muscle Status
                  </h4>
                  <div className="space-y-2">
                    {priorities
                      .filter(p => !p.isPrimary)
                      .map(p => (
                        <div key={p.muscle} className="space-y-1">
                          <div className="flex justify-between text-[11px]">
                            <span className="capitalize">{p.muscle}</span>
                            <span className="text-gray-600">
                              {p.current.toFixed(1)}/{medTarget} · {Math.round(p.percentage)}%
                            </span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                            <div
                              className="progress-bar h-1.5 rounded-full bg-blue-500"
                              style={{ width: `${Math.min(p.percentage, 100)}%` }}
                            />
                          </div>
                        </div>
                      ))}
                  </div>
                </div>
              </div>
            </>
          )}
        </div>
      );

      const ArchiveView = () => {
        const sorted = [...workoutHistory].sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );
        return (
          <div className="space-y-4">
            <div className="bg-gradient-to-r from-gray-600 to-gray-700 text-white p-6 rounded-lg shadow">
              <h1 className="text-lg font-bold mb-1">Workout Archive</h1>
              <p className="text-[11px] text-gray-100">
                {sorted.length} logged entries
              </p>
            </div>
            <div className="bg-white rounded-lg shadow p-4">
              {sorted.length === 0 && (
                <p className="text-xs text-gray-600">No workouts logged yet.</p>
              )}
              <div className="space-y-2">
                {sorted.map(w => {
                  const d = new Date(w.date);
                  return (
                    <div
                      key={w.id}
                      className="border border-gray-200 rounded-md px-3 py-2 text-[11px] bg-gray-50"
                    >
                      <div className="flex justify-between mb-1">
                        <span className="font-semibold">{w.exercise}</span>
                        <span className="text-gray-500">
                          {d.toLocaleDateString()}{' '}
                          {d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>
                      </div>
                      <div className="text-gray-700">
                        {w.sets} sets · {w.variant}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      const TrendsView = () => (
        <div className="space-y-4">
          <div className="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-lg shadow">
            <h1 className="text-lg font-bold mb-1">Trends</h1>
            <p className="text-[11px] text-purple-100">
              High-level look at current week volumes.
            </p>
          </div>
          <div className="bg-white rounded-lg shadow p-4">
            <h3 className="text-sm font-bold mb-3 text-gray-900">Week Snapshot</h3>
            <p className="text-[11px] text-gray-600 mb-3">
              Same data as the main screen, just laid out together.
            </p>
            <div className="space-y-2">
              {priorities.map(p => (
                <div key={p.muscle} className="space-y-1">
                  <div className="flex justify-between text-[11px]">
                    <span className="capitalize">
                      {p.muscle} {p.isPrimary ? '(primary)' : '(accessory)'}
                    </span>
                    <span>
                      {p.current.toFixed(1)}/{medTarget} · {Math.round(p.percentage)}%
                    </span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                    <div
                      className={
                        'progress-bar h-1.5 rounded-full ' +
                        (p.isPrimary ? 'bg-purple-500' : 'bg-blue-400')
                      }
                      style={{ width: `${Math.min(p.percentage, 100)}%` }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      const SettingsView = () => (
        <div className="space-y-4">
          <div className="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-6 rounded-lg shadow">
            <h1 className="text-lg font-bold mb-1">Settings</h1>
            <p className="text-[11px] text-slate-200">
              MED + strength reminder tuning.
            </p>
          </div>
          <div className="bg-white rounded-lg shadow p-4 space-y-3 text-xs">
            <div>
              <label className="block font-semibold mb-1">
                MED target per muscle (sets/week)
              </label>
              <input
                type="number"
                min="4"
                max="20"
                value={medTarget}
                onChange={e => setMedTarget(Number(e.target.value) || medTarget)}
                className="border rounded-md px-2 py-1 w-20 text-xs"
              />
              <p className="text-[11px] text-gray-500 mt-1">
                Used for both primary and accessory muscles. Primary still drive recommendations.
              </p>
            </div>
            <div>
              <label className="block font-semibold mb-1">
                Strength reminder cycle (days)
              </label>
              <input
                type="number"
                min="7"
                max="30"
                value={strengthCycleDays}
                onChange={e =>
                  setStrengthCycleDays(Number(e.target.value) || strengthCycleDays)
                }
                className="border rounded-md px-2 py-1 w-20 text-xs"
              />
              <p className="text-[11px] text-gray-500 mt-1">
                If you haven&apos;t logged Squats, Bench, or Deadlifts in this many days,
                a reminder appears.
              </p>
            </div>
            <div className="border-t pt-3">
              <h3 className="font-bold text-gray-900 text-xs mb-1">Philosophy</h3>
              <p className="text-[11px] text-gray-600">
                Big 6 muscles drive the engine. The Big 4 movement categories (press, pull,
                squat, posterior) make the day intuitive. Accessories are tracked and
                surfaced so you can top them up by choice, not by algorithm.
              </p>
            </div>
          </div>
        </div>
      );

      const BottomNav = () => (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 shadow-lg">
          <div className="max-w-2xl mx-auto flex justify-around text-xs">
            <button
              onClick={() => setCurrentView('workout')}
              className={
                'flex flex-col items-center ' +
                (currentView === 'workout' ? 'text-blue-600' : 'text-gray-400')
              }
            >
              <TrendingUp />
              <span className="mt-1">Workout</span>
            </button>
            <button
              onClick={() => setCurrentView('archive')}
              className={
                'flex flex-col items-center ' +
                (currentView === 'archive' ? 'text-blue-600' : 'text-gray-400')
              }
            >
              <ArchiveIcon />
              <span className="mt-1">Archive</span>
            </button>
            <button
              onClick={() => setCurrentView('trends')}
              className={
                'flex flex-col items-center ' +
                (currentView === 'trends' ? 'text-blue-600' : 'text-gray-400')
              }
            >
              <TrendingUp />
              <span className="mt-1">Trends</span>
            </button>
          </div>
        </div>
      );

      const QuickAddModal = () => {
        if (!showQuickAdd) return null;

        const accessoryExercises = Object.entries(exerciseLibrary)
          .filter(([_, data]) => data.category === 'accessory')
          .map(([name]) => name)
          .sort();

        const selectedData = quickAddExercise
          ? exerciseLibrary[quickAddExercise]
          : null;
        const variants = selectedData?.variants || [];
        const defaultVar =
          quickAddExercise &&
          lastUsedVariants[quickAddExercise] &&
          variants.includes(lastUsedVariants[quickAddExercise])
            ? lastUsedVariants[quickAddExercise]
            : variants[0] || '';

        const effectiveVariant = quickAddVariant || defaultVar;

        return (
          <div className="fixed inset-0 bg-black/40 modal-overlay flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
              <div className="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
                <h3 className="text-sm font-bold">Add Accessory Exercise</h3>
                <button
                  onClick={() => {
                    setShowQuickAdd(false);
                    setQuickAddExercise('');
                    setQuickAddVariant('');
                    setQuickAddSets(3);
                  }}
                  className="text-xs text-gray-500 hover:text-gray-800"
                >
                  Close
                </button>
              </div>
              <div className="p-4 space-y-3 text-xs">
                <div>
                  <label className="block font-medium mb-1">Accessory exercise</label>
                  <select
                    value={quickAddExercise}
                    onChange={e => {
                      const value = e.target.value;
                      setQuickAddExercise(value);
                      if (value) {
                        const ex = exerciseLibrary[value];
                        const v = ex.variants || [];
                        const autoVar =
                          lastUsedVariants[value] && v.includes(lastUsedVariants[value])
                            ? lastUsedVariants[value]
                            : v[0] || '';
                        setQuickAddVariant(autoVar);
                      } else {
                        setQuickAddVariant('');
                      }
                    }}
                    className="w-full border-2 border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="">Select an accessory...</option>
                    {accessoryExercises.map(name => (
                      <option key={name} value={name}>
                        {name}
                      </option>
                    ))}
                  </select>
                </div>

                {quickAddExercise && (
                  <>
                    <div>
                      <label className="block font-medium mb-1">Variation</label>
                      <select
                        value={effectiveVariant}
                        onChange={e => setQuickAddVariant(e.target.value)}
                        className="w-full border-2 border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                      >
                        {variants.map(v => (
                          <option key={v} value={v}>
                            {v}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block font-medium mb-1">Sets</label>
                      <div className="flex items-center gap-3">
                        <button
                          type="button"
                          onClick={() => setQuickAddSets(s => Math.max(1, s - 1))}
                          className="px-2 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
                        >
                          <Minus />
                        </button>
                        <span className="text-sm font-semibold min-w-[2rem] text-center">
                          {quickAddSets}
                        </span>
                        <button
                          type="button"
                          onClick={() => setQuickAddSets(s => Math.min(10, s + 1))}
                          className="px-2 py-1 border border-gray-300 rounded-md hover:bg-gray-50"
                        >
                          <Plus />
                        </button>
                      </div>
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        if (!quickAddExercise || !effectiveVariant) return;
                        logWorkout(quickAddExercise, effectiveVariant, quickAddSets);
                        setShowQuickAdd(false);
                        setQuickAddExercise('');
                        setQuickAddVariant('');
                        setQuickAddSets(3);
                      }}
                      className="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-md bg-green-600 text-white text-xs font-semibold hover:bg-green-700"
                    >
                      <CheckCircle />
                      <span>
                        Log {quickAddSets} sets of {effectiveVariant}
                      </span>
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Root layout
      return (
        <div className="min-h-screen bg-gray-100 pb-20">
          <div className="max-w-2xl mx-auto p-4">
            {currentView === 'workout' && <WorkoutView />}
            {currentView === 'archive' && <ArchiveView />}
            {currentView === 'trends' && <TrendsView />}
            {currentView === 'settings' && <SettingsView />}
          </div>
          <BottomNav />
          <QuickAddModal />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App />);
  </script>
</body>
</html>
